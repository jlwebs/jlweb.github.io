---
layout: post
title: "ä»base64åˆ°protobuf"
date: 2023-12-10
categories: jekyll
tags: ['ğŸ¥-OS']
comments: true
---

**1.base64è§„åˆ™**
> ## **Base64çš„ç”±æ¥**
> Base64ç®—æ³•æœ€æ—©åº”ç”¨äºè§£å†³ç”µå­é‚®ä»¶ä¼ è¾“çš„é—®é¢˜ã€‚æ—©æœŸï¼Œç”±äºâ€œå†å²é—®é¢˜â€ï¼Œç”µå­é‚®ä»¶åªå…è®¸ASCIIç å­—ç¬¦ã€‚å¦‚æœè¦ä¼ è¾“ä¸€å°å¸¦æœ‰éASCIIç å­—ç¬¦ä¸²çš„ç”µå­é‚®ä»¶ï¼Œå½“å®ƒé€šè¿‡æœ‰â€œå†å²é—®é¢˜â€çš„ç½‘å…³æ˜¯å°±å¯èƒ½å‡ºç°é—®é¢˜ã€‚
> è¿™ä¸ªç½‘å…³å¾ˆå¯èƒ½ä¼šå¯¹è¿™ä¸ªéASCIIç å­—ç¬¦çš„äºŒè¿›åˆ¶ä½åšè°ƒæ•´ï¼Œå³å°†è¿™ä¸ªéASCIIç çš„8ä½äºŒè¿›åˆ¶ç çš„æœ€é«˜ä½ç½®ä¸º0ã€‚æ­¤æ—¶ï¼Œç”¨æˆ·æ”¶åˆ°çš„é‚®ä»¶å°†ä¼šæ˜¯ä¸€å°çº¯ç²¹çš„ä¹±ç é‚®ä»¶ï¼ŒåŸºäºè¿™ä¸ªåŸå› å°±äº§ç”Ÿäº†Base64ç®—æ³•ã€‚

ç¼–ç è¡¨ï¼š
![](https://cdn.nlark.com/yuque/0/2023/webp/26575180/1693231365433-212eed4a-ea4e-46a5-b0bd-f2f313a3f482.webp#averageHue=%23f6f6f5&clientId=u45d9ec06-a1d1-4&from=paste&height=258&id=u98a7a820&originHeight=310&originWidth=515&originalType=url&ratio=2.4000000953674316&rotation=0&showTitle=false&status=done&style=none&taskId=u507e844f-0e23-42af-b843-e365be984b5&title=&width=429)
åŸæ¥ä¸€ä¸ªå­—èŠ‚8ä½ï¼Œåˆ’åˆ†6bitsä¸ºå•ä½è§£æï¼Œä¹Ÿå°±æ˜¯åŸæ¥3å­—èŠ‚=24ä½æ­£å¥½è§£ææˆ4ä¸ªbase64ç¬¦å·ï¼Œå ç©ºé—´å³3bytesæå‡åˆ°4bytesï¼Œå®è§‚ä¸Šä¼šè¡¨ç°æˆ3byte+3byte +Â·Â·Â·+ æœ€åä¸€èŠ‚ï¼›
å¦‚æœæœ€åä¸€æ®µä¸æ˜¯åˆšå¥½6bitså‘¢ï¼ŸNOï¼Œbase64æ˜¯æŒ‰ç…§4æ¢3çš„ç­–ç•¥æ¥çš„ï¼Œåªè¦ 0<æœ€åä¸€èŠ‚<3ï¼Œé‚£å°±ä¼šè¢«å¼ºè¡Œpadding = æ¥è¡¥é½ã€‚
ä¸¾ä¾‹ï¼Œæ¯”å¦‚2å­—èŠ‚æ•°æ® 8+8 â†’ 6+6+4 â†’ 6+6+6(4ä¸ªæœ‰æ•ˆbits)+pad*1
> åœ¨base64é‡Œï¼Œç”±äºè¾“å…¥æ•°æ®éƒ½æ˜¯å­—èŠ‚æµï¼Œä¸æ˜¯æŒ‰bitä½å•ä½ä¼ è¾“ï¼Œæ‰€ä»¥ï¼Œå³ä¾¿æœ€åé‚£ä¸ª6ï¼ˆ4+2ï¼‰æœ«å°¾è¢«å¡«å……äº†2ä¸ª0è¿˜åŸæ—¶å€™ä¹Ÿä¸ä¼šå—å½±å“ï¼Œæ­£ç¡®åˆ‡å‰²æŒ‰8bitè¿˜åŸå°±è¡Œäº†ï¼›
> **Q: **è‡³äºä¸ºä»€ä¹ˆå¼ºåˆ¶è¦æ±‚base64é•¿åº¦å¿…é¡»æ˜¯4çš„å€æ•°ï¼Œä¸æƒœå¼•å…¥=æ¥è¡¥é½å‘¢ï¼Ÿ

> **å…¶å®æœ«å°¾ç”¨=ç¬¦å·è¡¥é½å®Œå…¨æ²¡æœ‰å¿…è¦ï¼Œå°±æ˜¯ç¡¬å‡‘é•¿åº¦4çš„æ•´å€æ•°ï¼Œæ²¡æœ‰=æˆ‘ä¾ç„¶å¯ä»¥é€šè¿‡mod 4å¾—åˆ°éœ€è¦å‡ ä¸ªç­‰å·ï¼Œä¸å½±å“è§£æï¼Œä½†å…¶å®ä¹Ÿæœ‰ä¸€äº›å¥½å¤„â‘ **

> **å¼•ç”¨â‘ ï¼š**åœ¨ç¡¬ä»¶æ€§èƒ½æ°´å¹³ä¸é«˜çš„æ—¶ä»£ï¼Œå¼ºåˆ¶è¦æ±‚è¾“å…¥å¯ä»¥è¢«ç‰¹å®šæ•°æ•´é™¤å¯ä»¥ç®€åŒ–ä»£ç ä¸­çš„æ¡ä»¶åˆ¤æ–­ï¼Œæé«˜ inner loop æ€§èƒ½ã€‚
> ä»¥ glibc çš„ strlen å®ç°ä¸ºä¾‹ï¼Œæ¯æ¬¡è¯»å– 32bit æ•´æ•°è€Œä¸æ˜¯åªè¯»å–ä¸€ä¸ª byteï¼Œæ˜¯å¸¸è§çš„æ±‡ç¼–æ‰‹åŠ¨ä¼˜åŒ–æŠ€å·§ï¼Œç®€åŒ–äº†ä»£ç ï¼›

**2.base128**
base128æ˜¯ä¸ºäº†è§£å†³4æ¢3å­—èŠ‚ï¼Œç©ºé—´åˆ©ç”¨ç‡åªæœ‰75%çš„é—®é¢˜çš„ï¼Œbase128å¦‚æœå¯è¡Œ, æµªè´¹ç‡å¯é™ä½åˆ°12.5%ï¼›
> asciié‡Œæ‰“å°å­—ç¬¦åªæœ‰96ä¸ªï¼Œè¿™é‡Œä¼šå¼•å‡ºbase128çš„é—®é¢˜ï¼Œæ€ä¹ˆå¤Ÿè¡¨ç¤ºå‘¢ï¼ŒåŠ ä¸Šéæ‰“å°çš„æ§åˆ¶å­—ç¬¦ä¸€å…±ä¹Ÿå°±128ä¸ªasciiå­—ç¬¦ï¼Œè™½è¯´éæ‰“å°å­—ç¬¦ä¹Ÿå®šä¹‰äº†å¯¹åº”ç‰¹æ®Šç¬¦å·åªæ˜¯ä¸å¤ªç¾è§‚

![](https://cdn.nlark.com/yuque/0/2023/png/26575180/1693238666972-5b66d693-5259-4c9a-90a0-17f9ae7d1b74.png#averageHue=%23e2e4e2&clientId=u45d9ec06-a1d1-4&from=paste&height=335&id=u1a66e202&originHeight=633&originWidth=972&originalType=url&ratio=2.4000000953674316&rotation=0&showTitle=false&status=done&style=none&taskId=uc233ad14-04b1-43f5-86d8-c65ed0e738e&title=&width=513.9973754882812)
> å³ä½¿ä¸è€ƒè™‘ padéœ€è¦128+1ä¸ªå­—ç¬¦ï¼Œascii ä¸­åŒ…å«äº†ä¸€äº›ä¸å¯ä»¥æ­£å¸¸æ‰“å°çš„æ§åˆ¶å­—ç¬¦ï¼Œç¼–ç ä¹‹åçš„å­—ç¬¦è¿˜å¯èƒ½åŒ…å«ä¼šè¢«ä¸åŒæ“ä½œç³»ç»Ÿè½¬æ¢çš„æ¢è¡Œç¬¦å·ï¼ˆ10 å’Œ 13ï¼‰ã€‚å› æ­¤ï¼ŒBase 64 è‡³ä»Šä¾ç„¶æ²¡æœ‰è¢« Base 128 æ›¿ä»£ã€‚

> Base 64 çš„è§„åˆ™å› ä¸ºä¸Šè¿°é™åˆ¶ä¸èƒ½å®Œç¾åœ°æ‰©å±•åˆ° Base 128ï¼Œæ‰€ä»¥ç°æœ‰åŸºäº Base 64 æ‰©å±•è€Œæ¥çš„ç¼–ç æ–¹å¼å¤§éƒ¨åˆ†éƒ½å±äºå˜ç§ï¼šå¦‚ LEB128ï¼ˆLittle-Endian Base 128ï¼‰ã€ Base 85 ï¼ˆAscii 85ï¼‰ï¼Œä»¥åŠæœ¬æ–‡çš„ä¸»è§’ï¼šBase 128 Varintsã€‚
é“¾æ¥ï¼šhttps://www.zhihu.com/question/585411183/answer/2907926748

**3.protobuf**
ä¸»è¦æ˜¯è®¾è®¡ç”¨æ¥è·¨å¹³å°ã€é«˜æ•ˆçš„äºŒè¿›åˆ¶åºåˆ—åŒ–åè®®
> å¯¹æ¯”Cç›´æ¥å‘é€ç»“æ„ä½“çš„ä¼˜åŠ¿æ˜¯è·¨è¯­è¨€ã€çœç©ºé—´ï¼ˆé€Ÿåº¦æ¯”ä¸è¿‡ç»“æ„ä½“ï¼‰  å¯¹æ¯”JSONç­‰çš„ä¼˜åŠ¿æ˜¯æ•ˆç‡é«˜ï¼ˆä½†å¯è¯»æ€§

- **Base128 Varints ç¼–ç è§„åˆ™**

ä½œä¸ºProtobufçš„åŸºæœ¬åº•å±‚ç¼–ç é€»è¾‘ï¼š
å»é™¤é«˜ä½0, æŒ‰7bitsåˆ†ç»„è§£æï¼Œæœ€é«˜ä½bitè®°å½•æœ€åä¸€ä¸ªæ•°æ®è¿˜æ˜¯ä¸­é—´æ•°æ®ï¼Œé‡‡ç”¨å°ç«¯ä¿å­˜ï¼ˆé€†åºbitå­˜å…¥ï¼‰
Protobufé’ˆå¯¹ä¸åŒæ•°æ®ç±»å‹ä»¥åŠæ•°æ®èŒƒå›´é‡‡ç”¨ç­–ç•¥ä¸åŒï¼Œä»¥ä¸‹æ˜¯æ¶‰åŠåˆ°çš„å¤šç±»ç¼–ç è¾…åŠ©å¤„ç†ä¸åŒæƒ…å†µï¼š

- **ZigZag ç¼–ç **

è§£å†³è´Ÿæ•°å ç”¨é«˜é—®é¢˜ï¼Œç”±äºè´Ÿæ•°åç å¯¼è‡´é«˜ä½å¡«å……1ï¼Œé‡‡ç”¨zigzagæŠŠè´Ÿæ•°è½¬ä¸ºæ­£æ•°
æ˜ å°„è§„å¾‹ï¼šæ­£æ•°nå˜ 2* n ï¼Œ è´Ÿæ•°nå˜ -2* n +1ï¼›å°±æ˜¯å¥‡å¶ç§»ä½ï¼Œä½†æ˜¯è´Ÿæ•°è¢«ç¿»å€äº†ï¼Œå› æ­¤èŒƒå›´ä¼šè¢«é™åˆ¶ï¼›æ¯”å¦‚8bitsçš„int8ç±»å‹ï¼Œå®é™…æ”¯æŒèŒƒå›´å‡åŠï¼Œå½“ç„¶protobufè‚¯å®šä¸ä¼šè¿™ä¹ˆåšï¼Œå¤šç­–ç•¥å¥½å¤„æŠŠå¤§æ•°é¢å¤–ç­–ç•¥è¿›è¡Œå¤„ç†äº†ã€‚

- 32-bit & 64-bit

å•çº¯çš„32ä½å’Œ64ä½ï¼Œç”¨äºå¤„ç†protobufæ— æ³•å‹ç¼©çš„æ•°æ®èŒƒå›´ï¼Œä¾‹å¦‚ 10000000, 7ä½åˆ†ç»„åå˜æˆä¸¤ç»„äº†ï¼Œéœ€è¦2ä¸ªå­—èŠ‚è¡¨ç¤ºåŸæ¥1byteäº†ï¼›è¿™æ—¶å€™å°±ç”¨è¿™ä¸ªpureç±»å‹ï¼›

- **Length-delimitedç¼–ç  **

ç”¨äºå¯¹stringç±»å‹ç¼–ç ï¼ŒæŠŠé•¿åº¦é™„åŠ åœ¨äº†æ•°æ®å¤´éƒ¨ï¼›
"Tag - Length - Value" æ˜¯ä¸€ç§å¸¸è§çš„æ•°æ®ç¼–ç ç»“æ„ï¼Œç”¨äºåœ¨é•¿åº¦é™å®šç¼–ç ä¸­ä¼ è¾“æˆ–å­˜å‚¨æ•°æ®ã€‚è¿™ç§ç»“æ„åœ¨è®¸å¤šåºåˆ—åŒ–æ ¼å¼ä¸­éƒ½æœ‰åº”ç”¨ï¼Œå…¶ä¸­æ¯ä¸ªå­—æ®µçš„æ•°æ®è¢«ç¼–ç ä¸ºä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼šæ ‡è®°ï¼ˆTagï¼‰ã€é•¿åº¦ï¼ˆLengthï¼‰å’Œå®é™…å€¼ï¼ˆValueï¼‰ã€‚
ä»‹ç»ï¼šTagç”Ÿæˆè§„åˆ™
![](https://cdn.nlark.com/yuque/0/2023/webp/26575180/1693248741208-222348eb-2fbe-45cf-ab71-1c3fbebf5bce.webp#averageHue=%23fcfbfb&clientId=u45d9ec06-a1d1-4&from=paste&height=323&id=u2fee5970&originHeight=562&originWidth=802&originalType=url&ratio=2.4000000953674316&rotation=0&showTitle=false&status=done&style=none&taskId=u94a8317e-999f-4056-8de0-a0343d0410c&title=&width=460.99737548828125)
ä¸¾ä¾‹:
```json
message MyMessage {
    int32 field1 = 1;
    string field2 = 2;
}
```

1. field1 (int32)ï¼š"wire type" æ˜¯ Varintï¼ˆ0x0ï¼‰ã€‚Varint ç”¨äºç¼–ç å˜é•¿æ•´æ•°ï¼Œå¦‚ int32ï¼Œå®ƒæ˜¯ä¸€ç§ç´§å‡‘çš„ç¼–ç æ–¹å¼ã€‚
2. field2 (string)ï¼š"wire type" æ˜¯ Length Delimitedï¼ˆ0x2ï¼‰ã€‚Length Delimited ç”¨äºç¼–ç é•¿åº¦é™å®šçš„æ•°æ®ï¼Œå¦‚å­—ç¬¦ä¸²ã€‚åœ¨ç¼–ç æ—¶ï¼Œä¼šå…ˆå†™å…¥å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œç„¶åæ˜¯å­—ç¬¦ä¸²çš„ UTF-8 ç¼–ç ã€‚
3. "field1" å’Œ "field2" åˆ†åˆ«æœ‰ field_number"ä¸º 1 å’Œ 2ã€‚å½“ç¼–ç è¿™ä¸ªæ¶ˆæ¯æ—¶ï¼Œç¼–ç å™¨ä¼šä½¿ç”¨ "field_number" å’Œå­—æ®µçš„ç±»å‹ä¿¡æ¯ä¸€èµ·ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ "tag"ï¼Œè¿™ä¸ª "tag" åŒ…å«äº† "field_number" å’Œå­—æ®µçš„ "wire type"ã€‚æ¥æ”¶æ–¹å¯ä»¥ä½¿ç”¨ "tag" ä¸­çš„ "field_number" æ¥è¯†åˆ«å¹¶æ­£ç¡®è§£ç å­—æ®µã€‚
> 1. **ä¼˜ç‚¹**ï¼š
>    - åœ¨ä¸éœ€è¦ä¾èµ–åˆ†éš”ç¬¦æˆ–å…¶ä»–ç»ˆæ­¢æ ‡è®°çš„æƒ…å†µä¸‹ï¼Œæ¥æ”¶æ–¹å¯ä»¥é«˜æ•ˆåœ°ä¼ è¾“å’Œå­˜å‚¨æ•°æ®ï¼Œå› ä¸ºå®ƒçŸ¥é“è¦æœŸæœ›å¤šå°‘æ•°æ®ã€‚
>    - å¯ç”¨äºç¼–ç ç»“æ„åŒ–æ•°æ®ã€äºŒè¿›åˆ¶æ•°æ®æˆ–ä»»ä½•å…¶ä»–ç±»å‹çš„æ•°æ®ã€‚
> 2. **ç¼ºç‚¹**ï¼š
>    - ç”±äºé•¿åº¦å‰ç¼€çš„å­˜åœ¨ï¼Œä¼šå¼•å…¥é¢å¤–çš„å¼€é”€ã€‚å¦‚æœé•¿åº¦å‰ç¼€å¤§äºå®é™…æ•°æ®ï¼Œè¿™ç§å¼€é”€å¯èƒ½ä¼šç›¸å½“å¤§ã€‚
>    - ç”±äºéœ€è¦ç®¡ç†é•¿åº¦ä¿¡æ¯ï¼Œç¼–ç å’Œè§£ç è¿‡ç¨‹å¯èƒ½ä¼šå˜å¾—æ›´åŠ å¤æ‚ã€‚

- **packed ç¼–ç **

å…¶å®æ˜¯L-Dç¼–ç è¡ç”Ÿä¼˜åŒ–ï¼ŒæŠŠ
Tag - Length - Value
Tag - Length - Value - 
Tag - Length - Value - Â·Â·Â· Tag - Length - Value Â·Â·Â·Â·Â·Â·
è¿™ç§é‡å¤çš„T-L-V - (TLV) ç±»å‹å­—æ®µ ä¼˜åŒ–æˆT-L-Vä¸€ä¸ªå¤§package
> åŸå…ˆçš„ repeated å­—æ®µçš„ç¼–ç ç»“æ„ä¸º **Tag-Length-Value-Tag-Length-Value-Tag-Length-Value...**ï¼Œå› ä¸ºè¿™äº› Tag éƒ½æ˜¯ç›¸åŒçš„ï¼ˆåŒä¸€å­—æ®µï¼‰ï¼Œå› æ­¤å¯ä»¥å°†è¿™äº›å­—æ®µçš„ Value æ‰“åŒ…ï¼Œå³å°†ç¼–ç ç»“æ„å˜ä¸º **Tag-Length-Value-Value-Value...**ã€‚


- **Protobufä¸­é‡å¤æ¶ˆæ¯çš„ç¼–ç è§„åˆ™**

repeatå­—æ®µæ˜¯æ€ä¹ˆå®ç°ç±»ä¼¼å®¹å™¨vectorçš„è¿½åŠ å‘¢ï¼Œç‰¹åˆ«æ˜¯é‡Œé¢å…ƒç´ ä¸ªæ•°å¦‚ä½•è§£æå‡ºæ¥ï¼š
å‡è®¾æ¥æ”¶æ–¹çš„ proto3 ä¸­å®šä¹‰äº†æŸä¸ªå­—æ®µï¼ˆå‡è®¾ field number=1ï¼‰ï¼Œå½“æ¥æ”¶æ–¹ä»å­—èŠ‚æµä¸­è¯»å–åˆ°å¤šä¸ª field number=1 çš„å­—æ®µæ—¶ï¼Œä¼šæ‰§è¡Œ merge æ“ä½œã€‚

**merge çš„è§„åˆ™å¦‚ä¸‹ï¼š**

- _**1ï¼‰**_å¦‚æœå­—æ®µä¸ºä¸å¯åˆ†å‰²çš„ç±»å‹ï¼Œåˆ™ç›´æ¥è¦†ç›–ï¼›
- _**2ï¼‰**_å¦‚æœå­—æ®µä¸º repeatedï¼Œåˆ™ append åˆ°å·²æœ‰å­—æ®µï¼›
- _**3ï¼‰**_å¦‚æœå­—æ®µä¸ºåµŒå¥—æ¶ˆæ¯ï¼Œåˆ™é€’å½’æ‰§è¡Œ mergeï¼›

å¦‚æœå­—æ®µçš„ field number ç›¸åŒä½†æ˜¯ç»“æ„ä¸åŒï¼Œåˆ™å‡ºç° errorã€‚

è¿™æ ·repeatedå­—æ®µçš„å€¼å°±ä¼šè¢«è¿½åŠ appedåˆ°ç‰¹å®šå®¹å™¨ä¸‹ï¼ŒåŒæ—¶ç»Ÿè®¡å‡ºproperty sizeï¼›
[IMé€šè®¯åè®®ä¸“é¢˜å­¦ä¹ (å››)ï¼šä»Base64åˆ°Protobufï¼Œè¯¦è§£Protobufçš„æ•°æ®ç¼–ç åŸç†-IMå¼€å‘/ä¸“é¡¹æŠ€æœ¯åŒº - å³æ—¶é€šè®¯å¼€å‘è€…ç¤¾åŒº!](http://www.52im.net/thread-4093-1-1.html)
ã€è­¦æƒ•æ€§èƒ½ç‚¹ã€‘ç”±äºrepeatedçš„è¿½åŠ ç‰¹æ€§å®Œæˆçš„å®¹å™¨insertæ“ä½œï¼Œæ³¨å®šæ€§èƒ½å·®ï¼Œå½“ä½ çš„repeatedæ•°é‡å¾ˆå¤§ï¼Œè€ƒè™‘æ”¹ç”¨å­—èŠ‚æ•°ç»„bytesï¼Œå¯ä»¥æ‰¹é‡ä¸€æ¬¡æ€§è½½å…¥å†…å­˜ï¼Œç„¶åæ ¹æ®å†…å­˜åˆ†å¸ƒè‡ªå·±è®¿é—®æŒ‡é’ˆæ¥å¿«é€Ÿè®¿é—®è¿™ä¸ªâ€œæ•°ç»„â€

- protoæ•°æ®ç»“æ„
| **Protobuf ç±»å‹** | **C# ç±»å‹** |
| --- | --- |
| double | double |
| float | float |
| int32 | int |
| int64 | long |
| uint32 | uint |
| uint64 | ulong |
| sint32 | int |
| sint64 | long |
| fixed32 | uint |
| fixed64 | ulong |
| sfixed32 | int |
| sfixed64 | long |
| bool | bool |
| string | string |
| bytes | ByteString |

