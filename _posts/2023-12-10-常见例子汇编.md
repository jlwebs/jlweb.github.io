---
layout: post
title: "å¸¸è§ä¾‹å­æ±‡ç¼–"
date: 2023-12-10
categories: jekyll
tags: ['ğŸ¥-CPP']
comments: true
---

### 1.lambda æ±‡ç¼–è°ƒç”¨è¿‡ç¨‹

```cpp
int n {};
auto funs = [n] () mutable {
    return ++n;
};
funs();
funs();
```
C++ insight: [click](https://cppinsights.io/lnk?code=Ly8gVHlwZSB5b3VyIGNvZGUgaGVyZSwgb3IgbG9hZCBhbiBleGFtcGxlLgojaW5jbHVkZSA8aW9zdHJlYW0+CmludCBzcXVhcmUoaW50IG51bSkgewoJaW50IG4ge307CiAgICAKCWF1dG8gZnVucyA9IFtuXSAoKSBtdXRhYmxlIHsKCQlyZXR1cm4gKytuOwoJfTsKICAgIGF1dG8gYj1mdW5zKCk7CiAgICBmdW5zKCk7CgkvL2NvdXQ8PGZ1bnMoKSA8PGVuZGw7CgkvL2NvdXQ8PGZ1bnMoKSA8PGVuZGw7Ci8vIGZvciAoaW50IGkgPSAyOyBpID4gMDsgaS0tKSB7Ci8vICAgICBpbnQgbiB7fTsKLy8gICAgIFtuXSAoKSBtdXRhYmxlIHsKLy8gICAgICAgICAgKytuIDsKLy8gICAgIH0oKTsgLy8gw6jCsMKDw6fClMKoIExhbWJkYSDDqMKhwqjDqMK+wr7DpcK8wo8KCi8vICAgICBbbl0gKCkgbXV0YWJsZSB7Ci8vICAgICAgICAgICsrbiA7Ci8vICAgICB9KCk7IC8vIMOowrDCg8OnwpTCqCBMYW1iZGEgw6jCocKow6jCvsK+w6XCvMKPCi8vIH0KCiAgICByZXR1cm4gMDsKfQ==&std=cpp2a&rev=1.0)
```cpp
  class __lambda_6_14
  {
    public: 
    inline /*constexpr */ int operator()()
    {
      return ++n;
    }
    
    private: 
    int n;
    
    public:
    __lambda_6_14(int & _n)
    : n{_n}
    {}
    
  };
```
å¦‚æœæ²¡æœ‰åŠ mutableåˆ™ä¼šå˜ä¸ºï¼š
`inline /*constexpr */ int operator()() const`
```cpp
#include <iostream>
int square(int num)
{
  int n = {};
    
  class __lambda_6_14
  {
    public: 
    inline /*constexpr */ int operator()() const
    //å¸¸æˆå‘˜å‡½æ•°
    {
      return n;
    }
    
    private: int n;
    
    public:
    __lambda_6_14(int & _n): n{_n}
    {}
    
  };
  
  __lambda_6_14 funs = __lambda_6_14{n};
  int b = static_cast<const __lambda_6_14>(funs).operator()();
    //å¸¸å¯¹è±¡å®ä¾‹æ‰å¯ä»¥è°ƒç”¨ const æˆå‘˜å‡½æ•°
  static_cast<const __lambda_6_14>(funs).operator()();
  return 0;
}
```
 
```cpp
_n$ = -8                                                ; size = 4
_funs$ = -4                                   ; size = 4
_num$ = 8                                         ; size = 4
int square(int) PROC                                    ; square
        push    ebp
        mov     ebp, esp
        sub     esp, 8
        mov     DWORD PTR _n$[ebp], 0
        lea     eax, DWORD PTR _n$[ebp]
        push    eax
        lea     ecx, DWORD PTR _funs$[ebp]
        call    <lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>::<lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>(int const &) ; <lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>::<lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>
        lea     ecx, DWORD PTR _funs$[ebp]
        call    <lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>::operator()(void) ; <lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>::operator()
        lea     ecx, DWORD PTR _funs$[ebp]
        call    <lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>::operator()(void) ; <lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>::operator()
        xor     eax, eax
        mov     esp, ebp
        pop     ebp
        ret     0
int square(int) ENDP                                    ; square

_this$ = -4                                   ; size = 4
_<n>$ = 8                                         ; size = 4
é»˜è®¤æ„é€ å‡½æ•°
<lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>::<lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>(int const &) PROC ; <lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>::<lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>
        push    ebp
        mov     ebp, esp
        push    ecx
        mov     DWORD PTR _this$[ebp], ecx
        mov     eax, DWORD PTR _this$[ebp]
        mov     ecx, DWORD PTR _<n>$[ebp]
        mov     edx, DWORD PTR [ecx]
        mov     DWORD PTR [eax], edx
        mov     eax, DWORD PTR _this$[ebp]
        mov     esp, ebp
        pop     ebp
        ret     4
<lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>::<lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>(int const &) ENDP ; <lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>::<lambda_41ba799f4cfe0531d69dc71ad1bbcdb9>

tv66 = -8           ; ä¸´æ—¶å˜é‡ tv66 åœ¨æ ˆä¸­çš„ç›¸å¯¹åç§»ä¸º -8ï¼Œå¤§å°ä¸º 4 å­—èŠ‚
_this$ = -4         ; å‡½æ•°å‚æ•° this æŒ‡é’ˆåœ¨æ ˆä¸­çš„ç›¸å¯¹åç§»ä¸º -4ï¼Œå¤§å°ä¸º 4 å­—èŠ‚

<lambda_3e268e853469f7c2a02c8b4edb2b84f5>::operator()(void) PROC ; å‡½æ•°åä¸º operator()ï¼Œè¿”å›ç±»å‹ä¸º voidï¼Œå‚æ•°åˆ—è¡¨ä¸ºç©º
        push    ebp        ; ä¿å­˜å½“å‰æ ˆå¸§åŸºå€æŒ‡é’ˆ ebp åˆ°æ ˆä¸­
        mov     ebp, esp   ; å°†å½“å‰æ ˆé¡¶æŒ‡é’ˆ esp èµ‹å€¼ç»™ ebpï¼Œå»ºç«‹æ–°çš„æ ˆå¸§
        sub     esp, 8     ; ä¸ºå‡½æ•°åˆ†é… 8 å­—èŠ‚çš„æ ˆç©ºé—´ï¼Œç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡å’Œå‡½æ•°è°ƒç”¨æ—¶çš„ä¸´æ—¶æ•°æ®
        mov     DWORD PTR _this$[ebp], ecx ; å°†å‡½æ•°å‚æ•° this æŒ‡é’ˆå­˜å‚¨åˆ° _this$ å˜é‡æ‰€åœ¨çš„å†…å­˜åœ°å€ä¸­
        mov     eax, DWORD PTR _this$[ebp] ; å°† _this$ å˜é‡çš„å€¼ï¼ˆå³å½“å‰å¯¹è±¡çš„æŒ‡é’ˆï¼‰å­˜å‚¨åˆ°å¯„å­˜å™¨ eax ä¸­
        mov     ecx, DWORD PTR [eax]      ; å°†å¯„å­˜å™¨ eax ä¸­å­˜å‚¨çš„æŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å­˜åœ°å€ä¸­çš„å€¼å­˜å‚¨åˆ°å¯„å­˜å™¨ ecx ä¸­ï¼Œå³å°†å½“å‰å¯¹è±¡çš„æˆå‘˜å˜é‡ x çš„å€¼åŠ è½½åˆ°å¯„å­˜å™¨ ecx ä¸­
        add     ecx, 1                   ; å°†å¯„å­˜å™¨ ecx ä¸­çš„å€¼åŠ  1ï¼Œå®ç° x çš„è‡ªå¢æ“ä½œ
        mov     DWORD PTR tv66[ebp], ecx ; å°†å¯„å­˜å™¨ ecx ä¸­çš„å€¼å­˜å‚¨åˆ°ä¸´æ—¶å˜é‡ tv66 æ‰€åœ¨çš„å†…å­˜åœ°å€ä¸­
        mov     edx, DWORD PTR _this$[ebp] ; å°† _this$ å˜é‡çš„å€¼ï¼ˆå³å½“å‰å¯¹è±¡çš„æŒ‡é’ˆï¼‰å­˜å‚¨åˆ°å¯„å­˜å™¨ edx ä¸­
        mov     eax, DWORD PTR tv66[ebp]  ; å°†ä¸´æ—¶å˜é‡ tv66 çš„å€¼å­˜å‚¨åˆ°å¯„å­˜å™¨ eax ä¸­
        mov     DWORD PTR [edx], eax      ; å°†å¯„å­˜å™¨ eax ä¸­çš„å€¼å­˜å‚¨åˆ°å¯„å­˜å™¨ edx æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€ä¸­ï¼Œå³å°†è‡ªå¢åçš„å€¼èµ‹ç»™ x
        mov     eax, DWORD PTR tv66[ebp]  ; å°†ä¸´æ—¶å˜é‡ tv66 çš„å€¼å­˜å‚¨åˆ°å¯„å­˜å™¨ eax ä¸­
        mov     esp, ebp                 ; å°†åŸºå€æŒ‡é’ˆ ebp çš„å€¼èµ‹ç»™å †æ ˆæŒ‡é’ˆ espï¼Œç”¨äºæ¢å¤å‡½æ•°ç°åœº
        pop     ebp                      ; å°†æ ˆé¡¶å…ƒç´ å¼¹å‡ºå¹¶å­˜å‚¨åˆ°åŸºå€æŒ‡é’ˆ ebp ä¸­ï¼Œç”¨äºæ¢å¤å‡½æ•°ç°åœº
        ret     0                        ; è¿”å›å‡½æ•°è°ƒç”¨è€…ï¼Œè¿”å›å€¼ä¸º 0
<lambda_3e268e853469f7c2a02c8b4edb2b84f5>::operator()(void) ENDP ; å‡½æ•°ç»“æŸ
```
```cpp
square(int)::{lambda()#1}::operator()():
        push    rbp
        mov     rbp, rsp
        mov     QWORD PTR [rbp-8], rdi
        mov     rax, QWORD PTR [rbp-8]
        mov     eax, DWORD PTR [rax]
        lea     edx, [rax+1]
        mov     rax, QWORD PTR [rbp-8]
        mov     DWORD PTR [rax], edx
        mov     rax, QWORD PTR [rbp-8]
        mov     eax, DWORD PTR [rax]
        pop     rbp
        ret
square(int):
        push    rbp
        mov     rbp, rsp
        sub     rsp, 24
        mov     DWORD PTR [rbp-20], edi
        mov     DWORD PTR [rbp-4], 0  //é»˜è®¤ int n{};
        mov     eax, DWORD PTR [rbp-4]
        mov     DWORD PTR [rbp-8], eax //æŠŠlambdaåŒ¿åç±»é‡Œnçš„åˆå§‹åŒ–ç¼–è¯‘åˆå¹¶åˆ°squareé‡Œäº†
                            //ä½¿ç”¨squareé‡Œçš„äºŒå·å±€éƒ¨å˜é‡å½“ä½œlambdaçš„private n;
        lea     rax, [rbp-8]
        mov     rdi, rax	//x86-64ä¸‹é»˜è®¤rdiå­˜æ”¾thisæŒ‡é’ˆç¬¬ä¸€ä¸ªå‚æ•°
        call    square(int)::{lambda()#1}::operator()()
        lea     rax, [rbp-8]
        mov     rdi, rax
        call    square(int)::{lambda()#1}::operator()()
        mov     eax, 0
        leave
        ret
__static_initialization_and_destruction_0(int, int):
        push    rbp
        mov     rbp, rsp
        sub     rsp, 16
        mov     DWORD PTR [rbp-4], edi
        mov     DWORD PTR [rbp-8], esi
        cmp     DWORD PTR [rbp-4], 1
        jne     .L7
        cmp     DWORD PTR [rbp-8], 65535
        jne     .L7
        mov     edi, OFFSET FLAT:_ZStL8__ioinit
        call    std::ios_base::Init::Init() [complete object constructor]
        mov     edx, OFFSET FLAT:__dso_handle
        mov     esi, OFFSET FLAT:_ZStL8__ioinit
        mov     edi, OFFSET FLAT:_ZNSt8ios_base4InitD1Ev
        call    __cxa_atexit
.L7:
        nop
        leave
        ret
_GLOBAL__sub_I_square(int):
        push    rbp
        mov     rbp, rsp
        mov     esi, 65535
        mov     edi, 1
        call    __static_initialization_and_destruction_0(int, int)
        pop     rbp
        ret
```

:::success
ä¸åŒæ¶æ„ä¼ å‚æ—¶å€™ï¼Œä½¿ç”¨å¯„å­˜å™¨ä¸åŒï¼Œæ¯”å¦‚x86ä¼ é€’thisæŒ‡é’ˆæ—¶å€™å°±ecxï¼Œ x86-64è¿™é‡Œç”¨çš„æ˜¯rdi
å…·ä½“çœ‹C++å‡½æ•°è°ƒç”¨æ–¹å¼
:::

### 2.x86 __fastcallè°ƒç”¨æ—¶ thisæŒ‡é’ˆçš„ä¼ é€’æ˜¯å¦è¿˜æ˜¯ecxï¼Ÿ
```cpp
int main(void)
{
    int n {};
    class __lambda_6_14
    {
    public: 
    inline /*constexpr */ int __fastcall operator()(int a, int b)
    {
        return a+b+n++;
    }

    private: 
    int n;

    public:
    __lambda_6_14(int & _n)
    : n{_n}
    {}

};

    __lambda_6_14 funs = __lambda_6_14{n};
    int b = funs.operator()(3,4);

    return 0;
}
```
```cpp
_b$ = -12                                     ; size = 4
_funs$ = -8                                   ; size = 4
_n$ = -4                                      ; size = 4
_main   PROC
    push    ebp
    mov     ebp, esp
    sub     esp, 12                           ; 0000000cH
    mov     DWORD PTR _n$[ebp], 0
                    lea     eax, DWORD PTR _n$[ebp]
    push    eax
    lea     ecx, DWORD PTR _funs$[ebp]
    call    `int main(void)'::`2'::__lambda_6_14::__lambda_6_14(int &) ; `main'::`2'::__lambda_6_14::__lambda_6_14
    push    4
    mov     edx, 3
    lea     ecx, DWORD PTR _funs$[ebp]
    call    int `int main(void)'::`2'::__lambda_6_14::operator()(int,int) ; `main'::`2'::__lambda_6_14::operator()
    mov     DWORD PTR _b$[ebp], eax
    xor     eax, eax
    mov     esp, ebp
    pop     ebp
    ret     0
_main   ENDP
```

1. çœ‹åˆ°äº†ï¼Œè¿˜æ˜¯ä»¥C++ç±»çš„___thiscall _ä¼˜å…ˆï¼Œecxä¼ é€’thisæŒ‡é’ˆï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ï¼‰ï¼Œedxä¼ é€’ç¬¬äºŒä¸ªå‚æ•°aï¼Œåé¢bå‚æ•°å…¥æ ˆã€‚
2. åœ¨ C++ ä¸­ï¼Œæ„é€ å‡½æ•°å’Œææ„å‡½æ•°æ˜¯ç‰¹æ®Šçš„æˆå‘˜å‡½æ•°ï¼Œå®ƒä»¬çš„åç§°ä¸ç±»åç§°ç›¸åŒï¼Œæ²¡æœ‰è¿”å›å€¼ï¼Œå¹¶ä¸”ä¸èƒ½è¢«ç›´æ¥è°ƒç”¨ã€‚ç¼–è¯‘å™¨åœ¨å¯¹è±¡åˆ›å»ºå’Œé”€æ¯æ—¶è‡ªåŠ¨è°ƒç”¨æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ã€‚å› æ­¤ï¼Œè¿™äº›å‡½æ•°çš„è°ƒç”¨çº¦å®šå¿…é¡»ä¸ç¼–è¯‘å™¨å’Œæ“ä½œç³»ç»Ÿçš„é»˜è®¤çº¦å®šä¸€è‡´ï¼Œå¦åˆ™ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚

åœ¨ Microsoft Visual C++ ç¼–è¯‘å™¨ä¸­ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯ __thiscall è°ƒç”¨çº¦å®šï¼Œè¿™æ˜¯ä¸€ç§ç±»ä¼¼äº stdcall çš„çº¦å®šï¼Œç”¨äºå°†å¯¹è±¡æŒ‡é’ˆä½œä¸ºéšå¼çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ã€‚å¦‚æœåœ¨æ„é€ å‡½æ•°æˆ–ææ„å‡½æ•°ä¸­ä½¿ç”¨äº†å…¶ä»–çš„è°ƒç”¨çº¦å®šï¼Œå°±ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ï¼Œå‡ºç°ç±»ä¼¼äº "illegal calling convention" çš„é”™è¯¯ä¿¡æ¯ã€‚
ç»§ç»­æ”¾å‡ºå®Œæ•´æ±‡ç¼–ï¼Œå¯ä»¥çœ‹åˆ°è¿˜æ˜¯åœ¨mainå‡½æ•°ç©ºé—´ çš„ ebp-8 æ ˆä¸Šä¿å­˜äº†lambdaå†…éƒ¨çš„nï¼›
`lea  ecx, DWORD PTR _funs$[ebp]` 
è¿™é‡Œecxä½œä¸ºè®¿é—®é»˜è®¤æ„é€ å‡½æ•°(__thiscallæ–¹å¼)çš„å”¯ä¸€å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ç±»çš„thisæŒ‡é’ˆ
> è¿™é‡Œæ„æ€æ˜¯æŠŠç±»å®ä¾‹ç©ºé—´å­˜æ”¾åˆ°äº†mainçš„æ ˆç©ºé—´ä¸Šï¼Œä¸ºå…¶å¼€è¾Ÿäº†4ä¸ªå­—èŠ‚ï¼›
std::cout << sizeof(__lambda_6_14) << std::endl; ç»“æœä¸º4

```cpp
_b$ = -12                                         ; size = 4
_funs$ = -8                                   ; size = 4
_n$ = -4                                                ; size = 4
_main   PROC
        push    ebp
        mov     ebp, esp
        sub     esp, 12                             ; 0000000cH
        mov     DWORD PTR _n$[ebp], 0
        lea     eax, DWORD PTR _n$[ebp]
        push    eax
        lea     ecx, DWORD PTR _funs$[ebp]
        call    `int main(void)'::`2'::__lambda_6_14::__lambda_6_14(int &) ; `main'::`2'::__lambda_6_14::__lambda_6_14
        push    4
        mov     edx, 3
        lea     ecx, DWORD PTR _funs$[ebp]
        call    int `int main(void)'::`2'::__lambda_6_14::operator()(int,int) ; `main'::`2'::__lambda_6_14::operator()
        mov     DWORD PTR _b$[ebp], eax
        xor     eax, eax
        mov     esp, ebp
        pop     ebp
        ret     0
_main   ENDP
tv70 = -12                                          ; size = 4
_a$ = -8                                                ; size = 4
_this$ = -4                                   ; size = 4
_b$ = 8                                       ; size = 4
int `int main(void)'::`2'::__lambda_6_14::operator()(int,int) PROC      ; `main'::`2'::__lambda_6_14::operator(), COMDAT
        push    ebp
        mov     ebp, esp
        sub     esp, 12                             ; 0000000cH
        mov     DWORD PTR _a$[ebp], edx
        mov     DWORD PTR _this$[ebp], ecx
        mov     eax, DWORD PTR _a$[ebp]
        add     eax, DWORD PTR _b$[ebp]
        mov     ecx, DWORD PTR _this$[ebp]
        add     eax, DWORD PTR [ecx]
        mov     DWORD PTR tv70[ebp], eax
        mov     edx, DWORD PTR _this$[ebp]
        mov     eax, DWORD PTR [edx]
        add     eax, 1
        mov     ecx, DWORD PTR _this$[ebp]
        mov     DWORD PTR [ecx], eax
        mov     eax, DWORD PTR tv70[ebp]
        mov     esp, ebp
        pop     ebp
        ret     4
int `int main(void)'::`2'::__lambda_6_14::operator()(int,int) ENDP      ; `main'::`2'::__lambda_6_14::operator()


_this$ = -4                                   ; size = 4
__n$ = 8                                                ; size = 4
`int main(void)'::`2'::__lambda_6_14::__lambda_6_14(int &) PROC   ; `main'::`2'::__lambda_6_14::__lambda_6_14, COMDAT
        push    ebp
        mov     ebp, esp
        push    ecx
        mov     DWORD PTR _this$[ebp], ecx
        mov     eax, DWORD PTR _this$[ebp]
        mov     ecx, DWORD PTR __n$[ebp]
        mov     edx, DWORD PTR [ecx]
        mov     DWORD PTR [eax], edx
        mov     eax, DWORD PTR _this$[ebp]
        mov     esp, ebp
        pop     ebp
        ret     4
`int main(void)'::`2'::__lambda_6_14::__lambda_6_14(int &) ENDP   ; `main'::`2'::__lambda_6_14::__lambda_6_14
```

### 3.åŒ¿åå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ
é¦–å…ˆå®šä¹‰ä¸€æ®µä»£ç 
```cpp
#include <iostream>
#include <stdio.h>
#include <string.h>
#include <cstring>


using namespace std;
class Test{
    public:
        int value;
        Test(){
            value=1; 
        }
        ~Test(){
            
        }
};
Test* ptr;

void foo(const Test &t)
{
    Test &mutable_t = const_cast<Test &>(t);
    mutable_t.value = 42; // ä¿®æ”¹ t.value çš„å€¼
    ptr = &mutable_t;
}

int main()
{
    //Test t2=Test();
    foo(Test()); // OK
    ptr->value = 10;
    return 0;
}
```
 foo(Test()); å…³äºè¿™é‡Œçš„åŒ¿åå¯¹è±¡Test()çš„ç”Ÿå‘½å‘¨æœŸåº”è¯¥åªæœ‰è¿™ä¸€è¡Œè¡¨è¾¾å¼ã€‚
ä½†æ˜¯æˆ‘ä»¬ä»æ±‡ç¼–ä»£ç ä¸­å¯ä»¥å‘å…ˆï¼Œå…¶åŒ¿åå¯¹è±¡æ˜¯åœ¨ï¼Œæ•°æ®æ®µ(Data Segement)åŒºåŸŸè¿›è¡Œç”Ÿæˆçš„ï¼Œ
åŒæ—¶åœ¨è¿™ä¸€è¡Œè¡¨è¾¾å¼ç»“æŸåï¼Œæˆ‘ä»¬ä¾ç„¶èƒ½å¤Ÿé€šè¿‡å…¨å±€ptræŒ‡é’ˆå¯¹åŒ¿åå¯¹è±¡çš„å±æ€§è¿›è¡Œä¿®æ”¹ã€‚
ä½†æ˜¯è¯•å›¾è®¿é—® ptr->value ä¼šæŠ¥é”™ï¼š stack-use-after-scope

### 4.push_backå’Œemplace_back
```cpp
#include<string>
#include<vector>
using namespace std;
vector<string> vs;

void em(){
    vs.emplace_back("abcd");
}

void pu(){
    string temp("abcd");
    vs.push_back(move(temp));
}

int main(){
    return 0;
}
```
```cpp
å¯¹åº”ä»£ç ä¸ºï¼š
void pu(){
    vs.push_back("abcd");
}
//////////////////////////////////////////////////////////////////////////////////
pu():
        push    rbp
        mov     rbp, rsp
        push    rbx
        sub     rsp, 56
        lea     rax, [rbp-25]
        mov     QWORD PTR [rbp-24], rax
        nop
        nop
        lea     rdx, [rbp-25]
        lea     rax, [rbp-64]
        mov     esi, OFFSET FLAT:.LC0
        mov     rdi, rax
        call    std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >::basic_string<std::allocator<char> >(char const*, std::allocator<char> const&)
        lea     rax, [rbp-64]
        mov     rsi, rax
        mov     edi, OFFSET FLAT:vs[abi:cxx11]
        call    std::vector<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >, std::allocator<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > > >::push_back(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >&&)
        lea     rax, [rbp-64]
        mov     rdi, rax
        call    std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >::~basic_string() [complete object destructor]
        lea     rax, [rbp-25]
        mov     rdi, rax
        call    std::__new_allocator<char>::~__new_allocator() [base object destructor]
        nop
        jmp     .L18
        mov     rbx, rax
        lea     rax, [rbp-64]
        mov     rdi, rax
        call    std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >::~basic_string() [complete object destructor]
        jmp     .L15
        mov     rbx, rax
```
```cpp
pu():
        push rbp // ä¿å­˜è°ƒç”¨å‰çš„æ ˆåº•æŒ‡é’ˆ
        mov rbp, rsp // è®¾ç½®æ–°çš„æ ˆåº•æŒ‡é’ˆ
        push rbx // ä¿å­˜rbxå¯„å­˜å™¨çš„å€¼
        sub rsp, 56 // åœ¨æ ˆä¸Šåˆ†é…56å­—èŠ‚çš„ç©ºé—´
        lea rax, [rbp-25] // è®¡ç®—å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€
        mov QWORD PTR [rbp-24], rax // å°†å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å­˜å…¥æ ˆä¸­
        nop // ç©ºæŒ‡ä»¤
        nop // ç©ºæŒ‡ä»¤
        lea rdx, [rbp-25] // å°†å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å­˜å…¥rdxå¯„å­˜å™¨
        lea rax, [rbp-64] // å°†å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å­˜å…¥raxå¯„å­˜å™¨
        mov esi, OFFSET FLAT:.LC0 // å°†å­—ç¬¦ä¸²"abcd"çš„åœ°å€å­˜å…¥esiå¯„å­˜å™¨
        mov rdi, rax // å°†å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å­˜å…¥rdiå¯„å­˜å™¨
	// è°ƒç”¨std::stringçš„æ„é€ å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å¯¹è±¡
        call std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >::basic_string<std::allocator<char> >(char const*, std::allocator<char> const&) 
        lea rax, [rbp-25] // å°†å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å­˜å…¥raxå¯„å­˜å™¨
        mov rdi, rax // å°†å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å­˜å…¥rdiå¯„å­˜å™¨
	// è°ƒç”¨ææ„å‡½æ•°é”€æ¯å­—ç¬¦ä¸²å¯¹è±¡å†…éƒ¨çš„åˆ†é…å™¨å¯¹è±¡
        call std::__new_allocator<char>::~__new_allocator() [base object destructor] 
        nop // ç©ºæŒ‡ä»¤
        lea rax, [rbp-64] // å°†å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å­˜å…¥raxå¯„å­˜å™¨
        mov rdi, rax // å°†å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å­˜å…¥rdiå¯„å­˜å™¨
	// å°†å­—ç¬¦ä¸²å¯¹è±¡çš„å³å€¼å¼•ç”¨ç§»åŠ¨åˆ°rsiå¯„å­˜å™¨ä¸­
        call std::remove_reference<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >&>::type&& std::move<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >&>(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >&) 
        mov rsi, rax // å°†ç§»åŠ¨åçš„å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å­˜å…¥rsiå¯„å­˜å™¨
        mov edi, OFFSET FLAT:vs[abi:cxx11] // å°†vectorå¯¹è±¡vsçš„åœ°å€å­˜å…¥ediå¯„å­˜å™¨
	// call push_back å°†ç§»åŠ¨åçš„å­—ç¬¦ä¸²å¯¹è±¡æ·»åŠ åˆ°vectorä¸­
        call std::vector<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >, std::allocator<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > > >::push_back(std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >&&) 
        lea rax, [rbp-64] // å°†å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å­˜å…¥raxå¯„å­˜å™¨
        mov rdi, rax // å°†å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å­˜å…¥rdiå¯„å­˜å™¨
	// è°ƒç”¨ææ„å‡½æ•°é”€æ¯å­—ç¬¦ä¸²å¯¹è±¡
        call std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >::~basic_string() [complete object destructor] 
        jmp .L18 // è·³è½¬åˆ°.L18æ ‡ç­¾å¤„
        
        .L18:
        mov rbx, rax // å°†raxå¯„å­˜å™¨çš„å€¼å­˜å…¥rbxå¯„å­˜å™¨
        lea rax, [rbp-25] // è®¡ç®—å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€
        mov rdi, rax // å°†å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å­˜å…¥rdiå¯„å­˜å™¨
	// è°ƒç”¨ææ„å‡½æ•°é”€æ¯å­—ç¬¦ä¸²å¯¹è±¡å†…éƒ¨çš„åˆ†é…å™¨å¯¹è±¡
        call std::__new_allocator<char>::~__new_allocator() [base object destructor] 
        nop // ç©ºæŒ‡ä»¤
        mov rax, rbx // å°†rbxå¯„å­˜å™¨çš„å€¼å­˜å…¥raxå¯„å­˜å™¨
        mov rdi, rax // å°†å­—ç¬¦ä¸²å¯¹è±¡çš„åœ°å€å­˜å…¥rdiå¯„å­˜å™¨
        call _Unwind_Resume // è°ƒç”¨_Unwind_Resumeå‡½æ•°æ¢å¤å¼‚å¸¸å¤„ç†ç¨‹åºçš„æ§åˆ¶æƒ
```
```cpp
.LC0:
        .string "abcd"
em():
        push    rbp
        mov     rbp, rsp
    
        mov     esi, OFFSET FLAT:.LC0
        mov     edi, OFFSET FLAT:vs[abi:cxx11]
        call    std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >& std::vector<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >, std::allocator<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > > >::emplace_back<char const (&) [5]>(char const (&) [5])
        nop

        pop     rbp
        ret
```
### 5.è™šå‡½æ•°åŠ ä¸Šconståˆ°åº•è°ƒç”¨å“ªä¸ª
```cpp
#include <iostream>

class Base {
public:
    virtual void display() const {
        std::cout << "I am Base class!" << std::endl;
    }

    virtual ~Base() {
    }
};

class Derive : public Base {
public:
    virtual void display() {
        std::cout << "I am Derive class!" << std::endl;
    }

    virtual ~Derive() {
    }
};

int main() {
    Base* pBase = new Derive();
    Derive* pDerive = new Derive();

    pBase->display();
    pDerive->display();

    delete pBase;
    delete pDerive;

    return 0;
}
```
åŸºç±»ä½¿ç”¨äº†constï¼Œæ­£ç¡®ç»“æœæ˜¯
I am Base class! 
I am Derive class!
è™šå‡½æ•°çš„è¦æ±‚æ˜¯ï¼Œå‡½æ•°åŸå‹ç›¸åŒï¼Œå‡½æ•°åŸå‹åŒ…æ‹¬ï¼šå‡½æ•°è¿”å›å€¼ã€å‡½æ•°åã€å‚æ•°åˆ—è¡¨ã€constä¿®é¥°ç¬¦ã€‚è¿™é‡Œconstä¿®é¥°ç¬¦åŒ…æ‹¬å‡½æ•°è¿”å›å€¼çš„ä¿®é¥°ï¼Œå‡½æ•°å½¢å‚çš„ä¿®é¥°ï¼Œå‡½æ•°æœ¬èº«çš„ä¿®é¥°ã€‚åªè¦æœ‰ä¸€å¤„æ²¡æœ‰å¯¹ä¸Š ï¼Œé‚£ä¹ˆå°±ä¸æ˜¯è™šå‡½æ•°çš„overrideï¼Œè€Œæ˜¯è°ƒç”¨åŸºç±»çš„åŒåå‡½æ•°ã€‚æ‰€ä»¥å¯¹äºåŸºç±»çš„cosntè™šå‡½æ•°ï¼Œå¦‚æœå­ç±»é‡å†™å¿˜è®°åŠ ä¸Šconstï¼Œç¼–è¯‘å™¨ä¼šè®¤ä¸ºæ˜¯åŸºç±»çš„å‡½æ•°ã€‚
é“¾æ¥ï¼š[https://blog.csdn.net/qq_66089313/article/details/131330739](https://blog.csdn.net/qq_66089313/article/details/131330739)
