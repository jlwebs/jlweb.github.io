---
layout: post
title: "webserver [å¤šçº¿ç¨‹]"
date: 2023-12-10
categories: jekyll
tags: ['ğŸ¥- é¡¹ç›®åº“']
comments: true
---

##### x.é¢è¯•é—®é¢˜
REFï¼š
[è½»é‡çº§æœåŠ¡å™¨ TinyWebServer --å‚è€ƒå’Œç†è§£ä¸‹çš„ç¬”è®° - èœé¸ŸC_5022 - åšå®¢å›­](https://www.cnblogs.com/wj0518/articles/17176104.html)
[LTæ¨¡å¼å’ŒETæ¨¡å¼ - DawnHouse - åšå®¢å›­](https://www.cnblogs.com/dawnHouse/p/16780046.html)
[æ·±å…¥ç†è§£ Linux çš„ epoll æœºåˆ¶åŠepollåŸç†](https://zhuanlan.zhihu.com/p/410316787?utm_id=0)
###### C++14è¯­æ³•å°è£…çº¿ç¨‹æ± æ˜¯ç”¨äº†ä»€ä¹ˆç‰¹æ€§
ä½¿ç”¨äº†å¯å˜é•¿å‚æ•°æ¨¡æ¿ç¼–ç¨‹ï¼Œå¯¹å…¶è¿›è¡Œæ”¹è¿›ï¼Œä½¿ç”¨æ¨¡æ¿å…ƒç¼–ç¨‹æ–¹æ³•ï¼Œä½¿å¾—çº¿ç¨‹æ± å¯æ¥å—ä»»æ„ç±»å‹çš„å‡½æ•°ã€‚
![image.png](https://cdn.nlark.com/yuque/0/2023/png/26575180/1694654906287-eb2968f8-d325-4597-ac6f-358516c72b0b.png#averageHue=%23f9f8f7&clientId=ua574f40f-c0da-4&from=paste&height=206&id=u59699a49&originHeight=688&originWidth=1618&originalType=binary&ratio=2.879999876022339&rotation=0&showTitle=false&size=108660&status=done&style=none&taskId=ua888b097-32e9-4bf8-aaf8-b7b6efcfe72&title=&width=484.8051452636719)
å…¶ä¸­typename...Argsä¸ºå¯å˜å‚æ•°ï¼Œå¯ä»¥æ¥å—ä»»æ„æ•°é‡çš„å‚æ•°ï¼Œé€šè¿‡bindå‡½æ•°å°†ä¼ å…¥çš„å‡½æ•°få’Œå¯¹åº”çš„å‚æ•°åˆ—è¡¨ç»‘å®šä¸ºå¯æ‰§è¡Œå¯¹è±¡ï¼Œå¹¶é€šè¿‡packged_taskå°è£…ä¸ºæ™ºèƒ½æŒ‡é’ˆï¼Œæœ€åé€šè¿‡åŒ¿åè¡¨è¾¾å¼åŒ…è£…ä¸ºfunction<void()>ç±»å‹ï¼Œä¼ å…¥é˜Ÿåˆ—ä¹‹ä¸­ã€‚å¦‚æœå…ˆè¦è·å–æ‰§è¡Œç»“æœï¼Œå¯ä»¥è¿”å›get_futureï¼Œå¤–éƒ¨é€šè¿‡getè·å–ç»“æœï¼Œä¸ç„¶å¯ä»¥ä¸è¿”å›å€¼ã€‚
å¦‚æœä¸ä½¿ç”¨packged_taskå†æ¬¡å°è£…ä¸€å±‚ï¼Œç›´æ¥ä½¿ç”¨ä¸€ä¸‹å½¢å¼ä»£ç åˆ™ä¼šå‡ºç°æ‰§è¡Œæ—¶å¯¹è±¡å·²ç»é‡Šæ”¾çš„æƒ…å†µï¼Œé€ æˆå´©æºƒã€‚è€Œfunctionå¯¹è±¡åˆæ— æ³•å°è£…ä¸ºæ™ºèƒ½æŒ‡é’ˆï¼Œæ•…éœ€ä½¿ç”¨packged_taskã€‚
###### ä½ çš„webserveræœ‰ä»€ä¹ˆä¸åŒä¹‹å¤„
â‘ çº¿ç¨‹æ± éƒ¨åˆ†ä½¿ç”¨äº†å˜é•¿æ¨¡æ¿ï¼ŒåŒæ—¶ä½¿ç”¨futureå’Œpackaged_taskè¿›è¡Œå·¥ä½œçº¿ç¨‹åŸæ± å°è£…ï¼Œä½¿ç”¨äº†RAIIæ€æƒ³ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç†èµ„æºè‡ªåŠ¨é‡Šæ”¾ï¼Œå¹¶å‘æ§åˆ¶ä½¿ç”¨äº†mutexå’Œcondition_variableï¼Œå®Œæˆä¸´ç•ŒåŒºäº’æ–¥è®¿é—®ï¼Œä»¥åŠå·¥ä½œçº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’ï¼›
æˆ‘ä»¬ä½¿ç”¨packaged_taskå°†å¯è°ƒç”¨å¯¹è±¡taskåŒ…è£…æˆäº†ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†ä»»åŠ¡æäº¤ç»™å·¥ä½œçº¿ç¨‹æ± æ‰§è¡Œï¼Œå¹¶ä½¿ç”¨futureè·å–ä»»åŠ¡æ‰§è¡Œç»“æœã€‚æœ€åï¼Œæˆ‘ä»¬ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚ä½¿ç”¨futureã€packaged_taskè¿›è¡Œå·¥ä½œçº¿ç¨‹æ± å°è£…å¯ä»¥è®©æˆ‘ä»¬æ›´åŠ æ–¹ä¾¿åœ°ä½¿ç”¨å·¥ä½œçº¿ç¨‹æ± ï¼›
unique_lockï¼šæ˜¯mutexæä¾›çš„ç±»ä¼¼æ™ºèƒ½æŒ‡é’ˆçš„è‡ªåŠ¨ç»´æŠ¤é”èµ„æºé‡Šæ”¾çš„å·¥å…·æ¨¡æ¿ï¼Œ**std::unique_lock ä¼šåœ¨æ„é€ æ—¶è‡ªåŠ¨ä¸Šé”**ï¼Œå¹¶åœ¨ææ„æ—¶è‡ªåŠ¨è§£é”ã€‚
condition_variable::waitç”¨æ³•ï¼šç­‰å¾…cvçš„notifyå¹¶é˜»å¡ï¼Œstd::condition_variable::wait å‡½æ•°éœ€è¦ä¸€ä¸ª std::unique_lock å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå¹¶ä¸”è¯¥ std::unique_lock å¯¹è±¡å¿…é¡»ä¸ç›¸åŒçš„äº’æ–¥é‡å…³è”ï¼Œå³m_cv.wait(lk, condition)é‡Œçš„lkï¼Œè¿™é‡Œä¼šæŠŠlkè§£é”å¹¶ç­‰å¾…é€šçŸ¥ï¼›
ä»»åŠ¡å®Œæˆåï¼Œé€šè¿‡condition_variable::cv.wait(lock);è¿›è¡Œä¼‘çœ ï¼Œæ‰§è¡Œå‰éœ€è¦ç¡®ä¿unique_lockæ„é€ è¿›è¡Œè·å–é”æƒé™ï¼Œç¡®ä¿æ‰§è¡Œwaitæ—¶å€™äº’æ–¥é‡å¤„äºè§£é”çŠ¶æ€ï¼Œä»¥ä¾¿é‡Šæ”¾mutexå ç”¨å¹¶ä¼‘çœ ï¼›
> Q: ä¸ºä»€ä¹ˆçº¿ç¨‹æ± ææ„æ—¶å€™è¦cv.notify_all()
> A:  ä¸€èˆ¬æ˜¯æŠ¢å¤ºåˆ°mutexæƒåï¼Œè®¾ç½®m_stopé€€å‡ºæ ‡å¿—ä½
> Q:ä¸ºä»€ä¹ˆçº¿ç¨‹æ± ææ„å‡½æ•°éœ€è¦å¯¹æ¯ä¸€ä¸ªthread.join();
> A: join()æ˜¯å¯¹ç›®æ ‡çº¿ç¨‹è¿›è¡Œé˜»å¡ç­‰å¾…ï¼Œå…¨éƒ¨é˜»å¡ç­‰å¾…æ„ä¹‰åœ¨äºï¼Œææ„çœŸæ­£é‡Šæ”¾è‡ªæˆ‘æ•°æ®ç©ºé—´å‰ï¼Œè®©çº¿ç¨‹å…ˆè¡Œé€€å‡ºï¼Œé¿å…è®¿é—®é‡Šæ”¾çš„å…¬å…±èµ„æºï¼›
> Q:è¯´è¯´ä½ å¯¹m_cv.wait(lk, condition)çš„ç†è§£
> Aï¼šä½¿ç”¨æ¡ä»¶å˜é‡æ—¶ï¼Œé€šå¸¸éœ€è¦ä¸äº’æ–¥é‡ä¸€èµ·ä½¿ç”¨ã€‚äº’æ–¥é‡çš„ä½œç”¨æ˜¯ä¿æŠ¤å…±äº«èµ„æºï¼Œç¡®ä¿åœ¨åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®å…±äº«èµ„æºï¼Œé¿å…æ•°æ®ç«äº‰å’Œå¹¶å‘è®¿é—®çš„é—®é¢˜ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œäº’æ–¥é‡ m_mutex å¯ä»¥ç”¨äºä¿æŠ¤æ¡ä»¶å˜é‡ m_cv çš„è®¿é—®ã€‚äº’æ–¥é‡ m_mutex çš„é”å®šå’Œè§£é”æ“ä½œæ§åˆ¶äº†å¯¹æ¡ä»¶å˜é‡ m_cv çš„è®¿é—®ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿæ“ä½œæ¡ä»¶å˜é‡ã€‚

â‘¡httpdéƒ¨åˆ†

###### æ˜¯å¦æµ‹è¯•QPS
ä½¿ç”¨webbenchæµ‹è¯•çš„ï¼Œblablabla
###### æ‰‹å†™å…±äº«ã€ç‹¬å æŒ‡é’ˆ ï¼ˆæ¨¡æ¿ç±»ï¼‰
```cpp
template<typename T>
class SharedPtr {
public:
    // æ„é€ å‡½æ•°
    SharedPtr(T* ptr) : ptr_(ptr), ref_count_(new int(1)) {}

    // æ‹·è´æ„é€ å‡½æ•°
    SharedPtr(const SharedPtr& other) : ptr_(other.ptr_), ref_count_(other.ref_count_) {
        (*ref_count_)++;
    }

    // ææ„å‡½æ•°
    ~SharedPtr() {
        if (--(*ref_count_) == 0) {
            delete ptr_;
            delete ref_count_;
        }
    }

    // é‡è½½èµ‹å€¼è¿ç®—ç¬¦
    SharedPtr& operator=(const SharedPtr& other) {
        if (this != &other) {
            if (--(*ref_count_) == 0) {
                delete ptr_;
                delete ref_count_;
            }
            ptr_ = other.ptr_;
            ref_count_ = other.ref_count_;
            (*ref_count_)++;
        }
        return *this;
    }

    // è§£å¼•ç”¨æ“ä½œç¬¦
    T& operator*() const {
        return *ptr_;
    }

    // æˆå‘˜è®¿é—®æ“ä½œç¬¦
    T* operator->() const {
        return ptr_;
    }

private:
    T* ptr_;        // å®é™…æŒ‡å‘çš„èµ„æº
    int* ref_count_; // è®°å½•å¼•ç”¨è®¡æ•°çš„æŒ‡é’ˆ
};

```
```cpp
#include <iostream>
using namespace std;

class Type
{
public:
    int a = 1;
};

template<typename T>
class smart_ptr
{
public:
    smart_ptr(T* ptr = NULL) : m_ptr(ptr) {}
    ~smart_ptr() {
        delete m_ptr;
    }
    T& operator*() const { return *m_ptr; }
    T* operator->() const { return m_ptr; }
    operator bool() const { return m_ptr; }

    // æ¬ç§»æ„é€ 
    smart_ptr(smart_ptr&& rhs) noexcept {
        m_ptr = rhs.m_ptr;
        rhs.m_ptr = NULL;
    }
    // æ¬ç§»èµ‹å€¼
    smart_ptr& operator=(smart_ptr&& rhs) noexcept {
        m_ptr = rhs.m_ptr;
        rhs.m_ptr = NULL;
        return *this;
    }
private:
    T* m_ptr;
};

int main()
{
    smart_ptr<Type> sptr(new Type);
    smart_ptr<Type> sptr2(std::move(sptr));  // è°ƒç”¨æ¬ç§»æ„é€ 
    smart_ptr<Type> sptr3;
    sptr3 = std::move(sptr2);  // è°ƒç”¨æ¬ç§»èµ‹å€¼
    return 0;
}
```

###### promiseã€futureã€packaged_taskæ¨¡æ¿ç±»
å…ˆçœ‹çœ‹task_packageçš„æ¨¡æ¿ç±»demoæºç 
###### åœ¨é¢å¯¹cv.waitå‰lock_guardï¼Œä¸ºä»€ä¹ˆç›´æ¥ç”¨mutex.lock(),unlock()ã€‚åè€…ä»€ä¹ˆæœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ
unique_lock ç›¸æ¯” lock_guard çš„å¥½å¤„æ˜¯ï¼šå¯ä»¥éšæ—¶ unlock() å’Œ lock()ï¼›
å¼‚å¸¸ä¸‹çš„åŒºåˆ«ï¼šmutexæ‰‹åŠ¨é‡Šæ”¾å­˜åœ¨é—®é¢˜ï¼Œlock_guardé¿å…è¿™ä¸ªé—®é¢˜ï¼Œåé¢è¯¦è¿°
_**å¸¸è§çš„ 4 ç§é”™è¯¯åœºæ™¯ï¼š**_

- Lock/Unlock ä¸æ˜¯æˆå¯¹å‡ºç°
- Copy å·²ä½¿ç”¨çš„ Mutexï¼ˆMutexæ˜¯å€¼ç±»å‹ï¼Œä¼ é€’çš„æ—¶å€™æ˜¯å¤åˆ¶ï¼‰
- é‡å…¥ (Mutexä¸æ˜¯å¯é‡å…¥é”)
- æ­»é”

æ­»é”ä¸€èˆ¬ä¼šåœ¨å¼‚å¸¸æ—¶å€™æ‰‹åŠ¨ç®¡ç†ç±»äº’æ–¥ç®¡ç†æ¨¡æ¿å‡ºç°ï¼š
**å¼‚å¸¸**ï¼šå¦‚æœåœ¨è·å–é”åå‘ç”Ÿå¼‚å¸¸ï¼Œä½ éœ€è¦åœ¨å¼‚å¸¸å¤„ç†ä¸­è®°å¾—é‡Šæ”¾é”ï¼Œä»¥å…é€ æˆæ­»é”ã€‚
_unique_lockå¯ä»¥ç›´æ¥æ›¿æ¢lock_guardï¼Œ_**_è°ƒç”¨unique_lockä¹Ÿä¸éœ€è¦æ‰‹åŠ¨è§£é”ï¼Œåªæ˜¯æä¾›äº†æå‰lockå’Œunlock_**_ã€‚_
###### çº¿ç¨‹æ± æ•°é‡æ€ä¹ˆè®¾è®¡å®‰æ’çš„ï¼Œæ— é™æ‰©å®¹ä¼šæœ‰ä»€ä¹ˆé—®é¢˜
###### m_stopéƒ¨åˆ†è®²æ¸…æ¥šï¼Œä»¥åŠä¸ªåˆ«garbageçº¿ç¨‹éœ€è¦é€€å‡ºå¦‚ä½•è®¾è®¡
m_stopå’Œqueue.empty()ä¸ºä»€ä¹ˆè¦è®¾è®¡æˆä¸¤æ¬¡æ£€æµ‹ï¼›
ç¬¬ä¸€æ¬¡æ£€æµ‹ï¼š` m_cv.wait(lk,[this](){ return m_stop||!tasks.empty();});  `
ç¬¬äºŒæ¬¡æ£€æµ‹ï¼š

å…³é”®æ˜¯è®²æ¸…æ¥š cv.wait(lock, function)




###### ä½ æåˆ°äº†promise/futureï¼Œfutureæ˜¯asyncå¯åŠ¨çš„å—ï¼Œæœ‰å“ªä¸‰ç§æ–¹å¼ï¼ˆ3ç§ç­–ç•¥ï¼‰ï¼Œå’Œthreadçš„å¼‚æ­¥åŒºåˆ«

1. threadå’Œasyncå¯åŠ¨çš„å¼‚æ­¥ä»»åŠ¡çš„åŒºåˆ«
C++ ä¸­ç”¨äºå¯åŠ¨å¼‚æ­¥ä»»åŠ¡çš„ä¸¤ç§ä¸åŒæ–¹å¼ï¼Œå®ƒä»¬ä¹‹é—´æœ‰ä»¥ä¸‹ä¸»è¦åŒºåˆ«ï¼š
1. **è¿”å›å€¼ç±»å‹**ï¼š
   - **std::thread**ï¼š**std::thread** ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ‰§è¡ŒæŒ‡å®šçš„å‡½æ•°ï¼Œå¹¶ä¸”ä¸ä¼šè¿”å›ä»»ä½•å€¼ã€‚å¦‚æœéœ€è¦è·å–å‡½æ•°çš„è¿”å›å€¼ï¼Œéœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼ï¼ˆå¦‚å¼•ç”¨æˆ–æŒ‡é’ˆå‚æ•°ï¼‰ä¼ é€’ã€‚
   - **std::async**ï¼š**std::async** ä¼šè¿”å›ä¸€ä¸ª **std::future** å¯¹è±¡ï¼Œå¯ä»¥ç”¨äºå¼‚æ­¥è·å–å‡½æ•°çš„è¿”å›å€¼ã€‚è¿™å…è®¸åœ¨éœ€è¦æ—¶ç­‰å¾…å‡½æ•°çš„å®Œæˆå¹¶è·å–å…¶è¿”å›å€¼ã€‚
2. **æ‰§è¡Œæ–¹å¼**ï¼š
   - **std::thread**ï¼š**std::thread** ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ‰§è¡ŒæŒ‡å®šçš„å‡½æ•°ï¼Œè¯¥çº¿ç¨‹ä¼šåœ¨åå°è¿è¡Œå¹¶ä¸”ä¸è°ƒç”¨çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œã€‚
   - **std::async**ï¼š**std::async** å¯ä»¥é€‰æ‹©åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨è°ƒç”¨çº¿ç¨‹ä¸­æ‰§è¡Œï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼‰ã€‚è¿™å–å†³äºä½¿ç”¨äº†å“ªç§å¯åŠ¨ç­–ç•¥ã€‚
3. **çº¿ç¨‹ç®¡ç†**ï¼š
   - **std::thread**ï¼šéœ€è¦æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæˆã€å¤„ç†çº¿ç¨‹çš„å¼‚å¸¸ç­‰ã€‚
   - **std::async**ï¼šå¯ä»¥é€šè¿‡ **std::future** æ¥å¼‚æ­¥è·å–å‡½æ•°çš„è¿”å›å€¼ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚
4. **è¿”å›ç»“æœçš„è·å–**ï¼š
   - **std::thread**ï¼šéœ€è¦æ‰‹åŠ¨å¤„ç†å‡½æ•°çš„è¿”å›ç»“æœï¼Œé€šå¸¸é€šè¿‡å¼•ç”¨æˆ–æŒ‡é’ˆå‚æ•°æ¥å®ç°ã€‚
   - **std::async**ï¼šå¯ä»¥é€šè¿‡è°ƒç”¨ **std::future** çš„ç­‰å¾…å‡½æ•°ï¼ˆå¦‚ **get()**ï¼‰æ¥è·å–å‡½æ•°çš„è¿”å›å€¼ã€‚
5. **å¼‚å¸¸å¤„ç†**ï¼š
   - **std::thread**ï¼šéœ€è¦æ‰‹åŠ¨å¤„ç†çº¿ç¨‹ä¸­å¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸ã€‚
   - **std::async**ï¼šå¯ä»¥é€šè¿‡ **std::future** å¯¹è±¡æ¥æ•è·å¼‚æ­¥ä»»åŠ¡ä¸­æŠ›å‡ºçš„å¼‚å¸¸ã€‚
6. **é»˜è®¤ç­–ç•¥**ï¼š
   - **std::thread**ï¼šæ€»æ˜¯åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œã€‚
   - **std::async**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ä»¥ç”±ç³»ç»Ÿå†³å®šæ˜¯åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œè¿˜æ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè¿™å–å†³äºå®ç°å’Œå½“å‰çš„ç³»ç»Ÿè´Ÿè½½ã€‚
7. **èµ„æºå›æ”¶**ï¼š
   - **std::thread**ï¼šéœ€è¦æ‰‹åŠ¨è°ƒç”¨ **join** æˆ– **detach** æ¥é‡Šæ”¾çº¿ç¨‹çš„èµ„æºã€‚
   - **std::async**ï¼šé€šå¸¸åœ¨è¿”å›çš„ **std::future** å¯¹è±¡é”€æ¯æ—¶è‡ªåŠ¨å›æ”¶ç›¸å…³èµ„æºã€‚
thread\async ä½¿ç”¨ä¾‹å­```cpp
#include <iostream>
#include <thread>

void printNumbers() {
    for (int i = 1; i <= 5; ++i) {
        std::cout << i << " ";
    }
    std::cout << std::endl;
}

int main() {
    std::thread t(printNumbers); // åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œå¹¶åœ¨è¯¥çº¿ç¨‹ä¸­æ‰§è¡Œ printNumbers å‡½æ•°
    t.join(); // ç­‰å¾…æ–°çº¿ç¨‹æ‰§è¡Œå®Œæ¯•

    std::cout << "Main thread continues..." << std::endl;
    return 0;
}

```
```cpp
#include <iostream>
#include <future>

int sum(int a, int b) {
    return a + b;
}

int main() {
    std::future<int> fut = std::async(sum, 3, 4); // å¼‚æ­¥æ‰§è¡Œ sum(3, 4) å‡½æ•°
    int result = fut.get(); // è·å–å¼‚æ­¥ä»»åŠ¡çš„è¿”å›å€¼
    std::cout << "Result: " << result << std::endl;
    return 0;
}

```

2. 3ç§asyncç­–ç•¥
**std::launch::async**ï¼š
   - æ„å‘³ç€åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ã€‚
   - **async** å°†å°½åŠ›ä¿è¯ä»»åŠ¡ä¼šåœ¨ä¸€ä¸ªæ–°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä½†å…·ä½“å®ç°å¯èƒ½ä¼šæ ¹æ®ç³»ç»Ÿå’Œèµ„æºæƒ…å†µè€Œå®šã€‚
1. **std::launch::deferred**ï¼š
   - æ„å‘³ç€ä»»åŠ¡å°†åœ¨éœ€è¦æ—¶ï¼ˆä¾‹å¦‚åœ¨è°ƒç”¨ **std::future::get()** æˆ– **std::future::wait()** æ—¶ï¼‰åœ¨è°ƒç”¨çº¿ç¨‹ä¸­åŒæ­¥æ‰§è¡Œï¼Œè€Œä¸ä¼šåˆ›å»ºæ–°çº¿ç¨‹ã€‚
   - å¦‚æœä½ åœ¨ä¸€ä¸ªæœªç­‰å¾…çš„ **std::future** ä¸Šè°ƒç”¨ **get()** æˆ– **wait()**ï¼Œåˆ™ä»»åŠ¡ä¼šåœ¨è°ƒç”¨çº¿ç¨‹ä¸­æ‰§è¡Œã€‚
2. **std::launch::async | std::launch::deferred**ï¼š
   - æ„å‘³ç€ç¼–è¯‘å™¨å¯ä»¥é€‰æ‹©åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åœ¨è°ƒç”¨çº¿ç¨‹ä¸­åŒæ­¥æ‰§è¡Œä»»åŠ¡ï¼Œå…·ä½“å–å†³äºå®ç°å’Œè¿è¡Œæ—¶çš„å› ç´ ã€‚
3. é¡¹ç›®é‡Œç”¨åˆ°çš„å¼‚æ­¥ä»»åŠ¡æ¨¡å¼

**æ²¡æœ‰ç”¨asyncæ–¹å¼ï¼Œæ˜¯é€šè¿‡ std::packaged_task**ï¼š
**std::packaged_task** å¯ä»¥å°†ä¸€ä¸ªå¯è°ƒç”¨å‡½æ•°åŒ…è£…æˆä¸€ä¸ª **std::future** å¯¹è±¡ã€‚ä½ å¯ä»¥å°†ä¸€ä¸ªå‡½æ•°æˆ–è€…å¯è°ƒç”¨å¯¹è±¡ä¼ é€’ç»™ **std::packaged_task** çš„æ„é€ å‡½æ•°ï¼Œç„¶åè°ƒç”¨ **get_future** æ–¹æ³•æ¥è·å–ä¸ä¹‹ç›¸å…³è”çš„ **std::future** å¯¹è±¡ã€‚
```
std::packaged_task<int()> task([](){ return 42; });
//ä¼ å…¥å‡½æ•°å¯¹è±¡
std::future<int> fut = task.get_future();
```
ç„¶åä½ å¯ä»¥åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨ **task()** æ¥æ‰§è¡ŒåŒ…è£…çš„å¯è°ƒç”¨å¯¹è±¡ï¼Œä»è€Œåœ¨å¼‚æ­¥ä»»åŠ¡ä¸­å¾—åˆ°ç»“æœã€‚
```cpp
auto taskPtr = std::make_shared<std::packaged_task<decltype(f(args...))()>>(
            std::bind(std::forward<F>(f),std::forward<Args>(args)...)
        );
```
std::make_sharedä»‹ç»ï¼šæ˜¯ C++ æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ï¼Œç”¨äºåŠ¨æ€åˆ†é…å†…å­˜å¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥å†…å­˜çš„ **std::shared_ptr** å¯¹è±¡ã€‚
**std::make_shared** æœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹ï¼š
1. **å†…å­˜åˆ†é…ä¼˜åŒ–**ï¼š**std::make_shared** ä¼šä¸€æ¬¡æ€§åˆ†é…å†…å­˜ç”¨äºå­˜å‚¨å¯¹è±¡å’Œæ§åˆ¶å—ï¼ˆç”¨äºè·Ÿè¸ªå¼•ç”¨è®¡æ•°ç­‰ä¿¡æ¯ï¼‰ï¼Œè¿™å¯èƒ½ä¼šæ¯”å•ç‹¬ä½¿ç”¨ **new** æ›´é«˜æ•ˆï¼Œå› ä¸ºå®ƒå‡å°‘äº†é¢å¤–çš„å†…å­˜åˆ†é…å’Œé”€æ¯æ“ä½œã€‚
2. **é¿å…å†…å­˜æ³„æ¼**ï¼šç”±äºä¸€æ¬¡æ€§åˆ†é…äº†å†…å­˜ï¼Œå³ä½¿åœ¨æ„é€ å‡½æ•°ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œå› ä¸ºå†…å­˜ä¼šåœ¨ **std::shared_ptr** çš„ææ„å‡½æ•°ä¸­æ­£ç¡®é‡Šæ”¾ã€‚
3. **æ›´åŠ ç®€æ´å’Œå®‰å…¨**ï¼šä½¿ç”¨ **std::make_shared** å¯ä»¥è®©ä»£ç æ›´åŠ ç®€æ´ï¼Œé¿å…æ‰‹åŠ¨ç®¡ç† **new** å’Œ **delete**ï¼Œä»è€Œé™ä½å‡ºé”™çš„å¯èƒ½æ€§ã€‚

package_taskæœ¬è´¨è¿˜æ˜¯ç”¨çš„ç¬¬ä¸€ç§æ–¹å¼åˆ›å»ºfutureå¯¹è±¡ï¼š
å³ std::promise<int>.get_future();
> ä¼ ç»Ÿpromiseå’Œfutureå…³è”æ–¹å¼ï¼Œpromiseå¯¹è±¡å¼•ç”¨æ–¹å¼ä¼ é€’ç»™è®¡ç®—å‡½æ•°ï¼Œä½œä¸ºä¸­é—´å€¼çš„set_value(res);
> void calculateValue(std::promise<int>& prom){ 
> int result = 42; 
> prom.set_value(result);
>  }
> std::promise<int> prom; // åˆ›å»ºä¸€ä¸ª promise å¯¹è±¡
>  std::future<int> fut = prom.get_future(); // è·å–ä¸ promise ç›¸å…³è”çš„ future å¯¹è±¡
> std::thread t(calculateValue, std::ref(prom));

###### å®Œæ•´çš„è®²ä¸€éçº¿ç¨‹æ± è¿™ä¸€å—å†…å®¹
> [åŸºæœ¬æ€è·¯] ç®¡ç†ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸€ä¸ªçº¿ç¨‹é˜Ÿåˆ—ï¼Œç„¶åæ¯æ¬¡å–ä¸€ä¸ªä»»åŠ¡åˆ†é…ç»™ä¸€ä¸ªçº¿ç¨‹å»åšï¼›
> - åœ¨æœåŠ¡å™¨ç«¯é¢„å…ˆåˆ›å»ºä¸€æ‰¹çº¿ç¨‹å’Œä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œæ¯å½“è·å–åˆ°ä¸€ä¸ªæ–°è¿æ¥æ—¶å°±å°†å…¶å°è£…æˆä¸€ä¸ªä»»åŠ¡å¯¹è±¡æ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—å½“ä¸­ã€‚
> - çº¿ç¨‹æ± ä¸­çš„è‹¥å¹²çº¿ç¨‹å°±ä¸æ–­ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡è¿›è¡Œå¤„ç†ï¼Œå¦‚æœä»»åŠ¡é˜Ÿåˆ—å½“ä¸­æ²¡æœ‰ä»»åŠ¡åˆ™çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œå½“æœ‰æ–°ä»»åŠ¡æ—¶å†å”¤é†’çº¿ç¨‹è¿›è¡Œä»»åŠ¡å¤„ç†ã€‚

1.ThreadPoolæ„é€ å‡½æ•°ä¸­å®Œæˆ8ä¸ªé»˜è®¤çº¿ç¨‹çš„åˆ›å»ºï¼ˆm_thread.emplace_back()ï¼‰ï¼Œå¹¶ç”¨cv.waité˜»å¡ç­‰å¾…ï¼Œæ¡ä»¶æ˜¯m_stop || !tasks.empty(), è¿™é‡Œå­çº¿ç¨‹å®é™…ä¸Šæ˜¯åŒ¿ålambdaå‡½æ•°ï¼Œæ·»åŠ åˆ°äº†m_threadä¸­ï¼Œå†…éƒ¨æ˜¯while(1)æ— é™å¾ªç¯çº¿ç¨‹ï¼›
:::success
**[this](){è®¿é—®ç±»æˆå‘˜}** æ˜¯ä¸€ä¸ªLambdaè¡¨è¾¾å¼ï¼ˆLambda expressionï¼‰ï¼Œè¿™é‡ŒLambdaè¡¨è¾¾å¼å®é™…ä¸Šæ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°å¯¹è±¡ï¼Œå¯ä»¥åƒå‡½æ•°ä¸€æ ·è¢«è°ƒç”¨ã€‚ä½¿ç”¨**[this]**æ¥æ•è·**this**æŒ‡é’ˆä½¿å¾—Lambdaè¡¨è¾¾å¼å¯ä»¥åœ¨å…¶ä¸­è®¿é—®ç±»çš„æˆå‘˜ã€‚
:::
2.ç­‰å¾…epoll_eventå‡ºç°EPOLLINæ ‡å¿—ï¼ˆ**EPOLLIN** è¡¨ç¤ºå…³è”çš„æ–‡ä»¶æè¿°ç¬¦å·²å‡†å¤‡å¥½è¿›è¡Œè¯»å–ã€‚ï¼‰å¼€å§‹æäº¤ä»»åŠ¡
 `pool.submit(do_accept, lfd, epfd); `ï¼ˆå…¶ä¸­do_acceptæ˜¯å¤„ç†æ–°å®¢æˆ·ç«¯å‡½æ•°ï¼‰
æˆ–è€…æ‰§è¡Œ `pool.(do_read, pev->data.fd, epfd); `ï¼ˆåç»­ä»»åŠ¡å˜æˆè¯·æ±‚å¤´è§£æå¹¶http_requestï¼‰
3.ç„¶åæ˜¯ä»»åŠ¡é˜Ÿåˆ—éƒ¨åˆ†ï¼Œæ˜¯åœ¨ThreadPoolé‡Œçš„æ¨¡æ¿å‡½æ•°`auto submit(F&& f,Args&&... args)`, å®Œæˆå¯¹æˆå‘˜å˜é‡
`_std::queue<std::function<void()>>tasks_`è¿›è¡Œemplace(ä»»åŠ¡ä¹‹æŒ‡é’ˆ)ï¼Œä»»åŠ¡æŒ‡é’ˆç”¨make_sharedè¿›è¡ŒåŒ…è£…äº†ä»¥ä¸‹å‡½æ•°
`F=std::bind(std::forward<F>(f),std::forward<Args>(args)...)`ï¼Œè‡³äºmake_sharedçš„å¥½å¤„å˜›è§é—®é¢˜8ï¼›
ç”±äº**std::shared_ptr<xxx> p_task;**ä¸ºä»€ä¹ˆéœ€è¦æ™ºèƒ½ç®¡ç†è§é—®é¢˜11ï¼›æ­¤æ—¶å†å»
`tasks.emplace(  **[taskPtr](){ (*taskPtr)(); }  **);` å»è§£å¼•ç”¨æ‰§è¡ŒFå‡½æ•°

###### ä¸ºä»€ä¹ˆè¦ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç†taskï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ªtaskPtrå»è°ƒç”¨ï¼Ÿé¿å…äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ
ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ **taskPtr** æ¥ç®¡ç† **std::packaged_task** å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæœ‰ä»¥ä¸‹å¥½å¤„ï¼š
1. **æ‰€æœ‰æƒç®¡ç†ï¼štaskPtr** æ˜¯ä¸€ä¸ª **std::shared_ptr**ï¼Œå®ƒä¼šåœ¨æ²¡æœ‰ä»»ä½•æŒ‡å‘å®ƒçš„æŒ‡é’ˆæ—¶è‡ªåŠ¨é‡Šæ”¾å†…å­˜ã€‚è¿™ç¡®ä¿äº†åœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œç›¸åº”çš„èµ„æºä¼šè¢«é‡Šæ”¾ï¼Œé¿å…äº†å†…å­˜æ³„æ¼ã€‚
2. **å…±äº«ä»»åŠ¡å¯¹è±¡ï¼š** å¯ä»¥å°† **taskPtr** ä¼ é€’ç»™å¤šä¸ªåœ°æ–¹ï¼Œè®©å¤šä¸ªçº¿ç¨‹èƒ½å¤Ÿå¼‚æ­¥è·å–ä»»åŠ¡çš„è¿”å›å€¼ã€‚
3. **é¿å…æ‚¬å‚æŒ‡é’ˆé—®é¢˜ï¼š** å¦‚æœä¸ä½¿ç”¨ **shared_ptr** ç®¡ç†ä»»åŠ¡å¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œå¦‚æœæœ‰å…¶ä»–åœ°æ–¹è¿˜å¼•ç”¨äº†è¯¥ä»»åŠ¡å¯¹è±¡ï¼Œå°±ä¼šäº§ç”Ÿæ‚¬å‚æŒ‡é’ˆé—®é¢˜ï¼ˆdangling pointerï¼‰ï¼Œå¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒæˆ–ä¸å¯é¢„æµ‹çš„è¡Œä¸ºã€‚
4. **std::packaged_task** å¯¹è±¡åªæ”¯æŒç§»åŠ¨æ„é€ 

æ€»çš„æ¥è¯´ï¼Œä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆå¯ä»¥æ–¹ä¾¿åœ°ç®¡ç†ä»»åŠ¡å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œç¡®ä¿åœ¨éœ€è¦æ—¶å¯ä»¥æ­£ç¡®åœ°é‡Šæ”¾ç›¸åº”çš„èµ„æºã€‚
###### moveè¯­ä¹‰çš„åŸç†
å°†äº¡å€¼ç”Ÿå‘½å‘¨æœŸè¿™å—å¿˜äº†ï¼Œçœ‹çœ‹cppéƒ¨åˆ†
ä»å®ç°ä¸Šè®²ï¼Œstd::moveåŸºæœ¬ç­‰åŒäºä¸€ä¸ªç±»å‹è½¬æ¢ï¼šstatic_cast<T&&>(lvalue);
###### æµ…æ‹·è´å’Œç§»åŠ¨æ‹·è´çš„åŒºåˆ«
æµ…æ‹·è´=åªæ‹·è´å˜é‡æœ¬èº«ï¼ˆå¦‚æœæ˜¯æŒ‡é’ˆï¼Œåˆ™å­˜åœ¨æ·±æ‹·è´æ¦‚å¿µï¼Œæ‹·è´ç›®æ ‡åœ°å€æ•°æ®ï¼‰
ç§»åŠ¨æ‹·è´=é€‰å–è¦æ‹·è´å˜é‡çš„åœ°å€è¿›è¡Œæ‹·è´åˆ°è‡ªå·±çš„å˜é‡ä¸Šï¼›

- å½“ç±»æ²¡æœ‰å®šä¹‰æ‹·è´æ„é€ å‡½æ•°çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨ä¼šé»˜è®¤æä¾›ä¸€ä¸ªï¼Œè¿™ä¸ªæ‹·è´å‡½æ•°æ˜¯**æµ…æ‹·è´**ã€‚**å¦‚æœè¯¥ç±»ä¸­å«æœ‰æŒ‡é’ˆï¼Œç¨‹åºç»“æŸåä¼šå‡ºç°é‡å¤é‡Šæ”¾çš„é—®é¢˜**
- ä¸ºäº†**è§£å†³æµ…æ‹·è´é€ æˆçš„æŒ‡é’ˆæˆå‘˜é‡å¤é‡Šæ”¾çš„é—®é¢˜**ï¼Œå¯ä»¥è‡ªå®šä¹‰æ·±**æ‹·è´æ„é€ å‡½æ•°**ã€‚é’ˆå¯¹æŒ‡é’ˆ[ç±»æˆå‘˜](https://so.csdn.net/so/search?q=%E7%B1%BB%E6%88%90%E5%91%98&spm=1001.2101.3001.7020)ï¼Œ**ä¸ºæ–°å¯¹è±¡åˆ†é…æ–°çš„ç©ºé—´ï¼Œå¯¹æºå¯¹è±¡ä¸­æŒ‡é’ˆæŒ‡å‘çš„å€¼è¿›è¡Œé‡æ–°æ„é€ **
- ä»ä»£ç è¡¨ç°ä¸Šæ¥çœ‹å’Œæµ…æ‹·è´æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯èƒŒåç¼–è¯‘å™¨å®ç°ä¸åŒï¼ŒæŠŠæ‰€æœ‰æƒè½¬ç§»äº†ï¼Œå¹¶æ²¡æœ‰æŠŠæ•°æ®è¿›è¡Œcopyï¼Œæœ¬è´¨ä¸Šæ¥çœ‹æ˜¯ä¸€ç§å®šå‘å¼•ç”¨ï¼›
###### NRVOå’ŒRVOå’Œmoveä½¿ç”¨çš„åŸç†
å› ä¸ºmoveåªæ˜¯å¼ºè½¬ä¸ºå³å€¼ï¼Œç”Ÿå‘½å‘¨æœŸå¹¶ä¸ä¼šæ”¹å˜ï¼Œéœ€è¦å€ŸåŠ©ç¼–è¯‘å™¨çš„NRVOç±»è¿”å›å€¼ä¼˜åŒ–ï¼ŒæŠŠä¸´æ—¶å˜é‡åœ¨è°ƒç”¨æ–¹æ ˆä¸Šåˆ›å»ºæ‰èƒ½æ”¹å˜ç”Ÿå‘½å‘¨æœŸï¼Œä»è€Œå³å€¼return move();æ‰æœ‰æ„ä¹‰
# å¦‚æœç¼–è¯‘å™¨æ²¡æœ‰å®æ–½è¿”å›å€¼ä¼˜åŒ–ï¼ˆå¦‚RVOæˆ–NRVOï¼‰ï¼Œå¹¶ä¸”ä½ å°è¯•ç§»åŠ¨ä¸€ä¸ªä¸´æ—¶ç±»å¯¹è±¡çš„æ‰€æœ‰æƒï¼Œå¯èƒ½ä¼šå¯¼è‡´æ‚¬ç©ºè®¿é—®ï¼ˆdangling accessï¼‰é—®é¢˜ã€‚# 

###### epollçš„I/Oå¤šè·¯å¤ç”¨å¦‚ä½•ç†è§£
å¤šè·¯å¤ç”¨è®©ä¸€ä¸ªè¿›ç¨‹åŒæ—¶å¤„ç†å¤šä¸ªIOä»»åŠ¡ï¼Œè€Œä¸éœ€è¦ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æˆ–è¿›ç¨‹ã€‚
**â€œå¤šè·¯â€**æŒ‡çš„æ˜¯å¤šä¸ªIOé€šé“ï¼ˆæ¯”å¦‚å¤šä¸ªsocketsï¼‰ï¼Œ
è€Œ**â€œå¤ç”¨â€**æŒ‡çš„æ˜¯é€šè¿‡ä¸€ç§æœºåˆ¶ï¼Œè®©ç¨‹åºèƒ½å¤Ÿæœ‰æ•ˆåœ°å¤„ç†å¤šä¸ªIOé€šé“çš„çŠ¶æ€å˜åŒ–ã€‚
###### epollçš„å“ªç§æ¨¡å¼ï¼Œç¨‹åºè¯»å–é€»è¾‘
epollé»˜è®¤æ˜¯level triggerçš„LTæ¨¡å¼ï¼Œå’Œpoll selectä¸€æ ·ï¼Œç¼“å†²åŒºæœ‰æ•°æ®å°±ä¸€ç›´é€šçŸ¥ï¼›
æˆ‘ç”¨çš„æ˜¯Edge triggeræ¨¡å¼ETä¸‹ï¼ŒåŒä¸€äº‹ä»¶å®Œæˆçš„ä¸Šå‡æ²¿ä»…é€šçŸ¥ä¸€æ¬¡ï¼Œéœ€è¦ä¸æ–­whileï¼ˆ1ï¼‰å»read,ç›´åˆ°ç¼“å†²åŒºä¸ºç©ºï¼›
###### epollçš„ETæ¨¡å¼å¦‚ä½•ä¸€æ¬¡è¯»å–å®Œæ•°æ®
åŸºäºç³»ç»Ÿè°ƒç”¨é”™è¯¯ç errnoï¼Œå¦‚æœreadè¿”å›0 æˆ–è€… errno==EWOULDBLOCK 
> ç³»ç»Ÿå‡½æ•°éƒ½æ˜¯æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1ï¼Œè€Œé”™è¯¯å·ä¿å­˜åœ¨å…¨å±€å˜é‡errnoä¸­ï¼Œè€Œpthreadåº“çš„å‡½æ•°éƒ½æ˜¯é€šè¿‡è¿”å›å€¼è¿”å›é”™è¯¯å·

###### epollçš„3ä¸ªæ¥å£ã€å‚æ•° ï¼Ÿè¯´ä¸€ä¸‹é¡¹ç›®ç½‘ç»œç¼–ç¨‹æ‰§è¡Œæµï¼Ÿ
int epoll_create(int size); 
int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);
int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);
**æ‰§è¡Œæµï¼š**

1. init_listen_fd(port, epfd) å…¨å±€socket(ipv4,tcp) & bindç»‘å®šipç«¯å£ï¼Œä¸ºå…¨å±€epollæ ‘ åˆ›å»ºlfdçš„ç›‘å¬äº‹ä»¶
2. do_accept(listen_fd, epfd) å…ˆå¤„ç†æ–°è¿æ¥ï¼Œacceptå–å‡ºå»ºç«‹å¥½çš„è¿æ¥å¥—æ¥å­—cfdï¼ŒæŒ‚åœ¨epollæ ‘ä¸Šï¼ŒETå¯¹äº‹ä»¶çš„EPOLLINäº‹ä»¶è¿›è¡Œç›‘å¬
3. ä»å·²å°±ç»ªé“¾è¡¨ç»“æ„ä¸­ï¼Œè·å¾—æ„Ÿå…´è¶£äº‹ä»¶é›†åˆ
###### errnoæ˜¯å¦æ˜¯çº¿ç¨‹å®‰å…¨ï¼Ÿ
POSIX.1cï¼ˆä¹Ÿç§°ä¸ºPOSIX.1-1996ï¼‰å¼•å…¥äº†å¯¹ errno çš„çº¿ç¨‹å®‰å…¨å®šä¹‰ï¼Œä»¥é¿å…åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­äº§ç”Ÿä¸ç¡®å®šçš„ç»“æœã€‚è¿™ä¸ªç‰ˆæœ¬çš„POSIXæ ‡å‡†ç¡®ä¿äº†æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„é”™è¯¯å·ï¼Œä»è€Œé¿å…äº†çº¿ç¨‹ä¹‹é—´çš„é”™è¯¯ä¿¡æ¯å¹²æ‰°ã€‚
![](https://cdn.nlark.com/yuque/0/2023/png/26575180/1698899598748-ad166912-7751-4236-ab61-2770ecc98c17.png#averageHue=%23f6f5f4&clientId=u59905aa9-5fdd-4&from=paste&id=u49fa2d46&originHeight=582&originWidth=1114&originalType=url&ratio=2.640000104904175&rotation=0&showTitle=false&status=done&style=none&taskId=ua5b418c0-9ab3-4362-90c1-d5d545375a7&title=)
[ã€ç²¾é€‰ã€‘ã€Linuxã€‘â…¥å¤šçº¿ç¨‹_ç”±äºåŒä¸€è¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å…±äº«å…¨å±€æ•°æ®,å› æ­¤,åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­å¦‚æœä¸€ä¸ªçº¿ç¨‹å¯¹å…¨å±€å˜-CSDNåšå®¢](https://blog.csdn.net/weixin_43737259/article/details/115773538)
###### asyncå’Œpackaged_taskå¼‚æ­¥ç¼–ç¨‹åŒºåˆ«
![image.png](https://cdn.nlark.com/yuque/0/2023/png/26575180/1698662209603-0f65ec04-3f99-4424-8ebc-9a7fbc2a58cd.png#averageHue=%23f7f3ea&clientId=u5690ee15-1a51-4&from=paste&height=170&id=u0f3f3e0e&originHeight=448&originWidth=1924&originalType=binary&ratio=2.640000104904175&rotation=0&showTitle=false&size=175570&status=done&style=none&taskId=uad5f01d3-8faf-4336-90a0-64ad2113e82&title=&width=728.7878498284515)
###### condition_variableæµç¨‹ç”¨æ³•
> ![image.png](https://cdn.nlark.com/yuque/0/2023/png/26575180/1699420218475-da18ae18-b568-4a77-a6ea-16ceab31c951.png#averageHue=%232c303a&clientId=ubaa79a07-5e84-4&from=paste&height=233&id=u26a3176f&originHeight=1226&originWidth=1340&originalType=binary&ratio=2.640000104904175&rotation=0&showTitle=false&size=1206494&status=done&style=none&taskId=ua1cdfbf8-64b5-4835-88e7-36b0ef69196&title=&width=254.5662841796875)![image.png](https://cdn.nlark.com/yuque/0/2023/png/26575180/1699420227014-ad6c4ab6-6042-4827-a5ab-7b1a6c3622a2.png#averageHue=%23272c36&clientId=ubaa79a07-5e84-4&from=paste&height=163&id=lP7P7&originHeight=567&originWidth=1339&originalType=binary&ratio=2.640000104904175&rotation=0&showTitle=false&size=426602&status=done&style=none&taskId=u471817f4-8906-455d-82a1-ff2f5a2647c&title=&width=385.18939208984375)

1.äº’æ–¥é” unique_lock æ˜¯é’ˆå¯¹å“ªé‡Œçš„ï¼Ÿ
äº’æ–¥é‡åŠ é”ä¸ºäº†ä¿è¯**æ¡ä»¶å˜åŒ–**çš„åŒæ­¥æ€§ï¼Œæ¡ä»¶æ˜¯å¯è¯»å†™å˜åŒ–çš„ï¼Œéœ€è¦ç”¨ä¸Šé”æ§åˆ¶å•ä¸€æ—¶é—´è®¿é—®ï¼Œç„¶åå†åˆ¤æ–­conditionï¼Œå¦‚æœä¸é€šè¿‡ï¼ˆfalseï¼‰åˆ™é‡Šæ”¾é”ï¼Œé˜»å¡ä¼‘çœ ï¼Œä¸ºäº†å…¶ä»–å…±äº«cvçš„çº¿ç¨‹åšå”¤é†’æ£€æµ‹ï¼›
å¦‚æœæ¡ä»¶ä¸ºtrueï¼ˆå…¶å®æ˜¯å¯è°ƒç”¨å‡½æ•°è¿”å›ç»“æœï¼‰ï¼Œåˆ™waitè¿”å›ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼ˆé˜»å¡å”¤é†’å®Œæˆï¼‰ï¼›
é‡Œé¢å…³é”®æºç é‡Œï¼Œæ˜¯å¦‚ä½•é˜»å¡çš„æ˜¯å…³é”®ï¼š
å…¶å®æ˜¯åŸºäºä¿¡å·ç­‰å¾…å®Œæˆä¼‘çœ å’Œå”¤é†’çš„ï¼Œå¤§è‡´é€»è¾‘å¦‚ä¸‹ï¼š
```cpp
void cv::wait(lk, æ¡ä»¶){
    while(æ¡ä»¶ä¸æ»¡è¶³){
        lk.unlock();
        wait(signal_coming)
        lk.lock();
    }
    return; //ä¿è¯ç»“æŸå‡½æ•°æ—¶å€™lkå¿…é¡»å¤„äºé”ä½çŠ¶æ€ï¼›
} 
```
**2.ä¸ºä»€ä¹ˆä¼šå‡ºç°è™šå‡å”¤é†’ï¼Œä¸ºä»€ä¹ˆè¦ç”¨whileæ¥é¿å…è™šå‡å”¤é†’ï¼Ÿ**
[ã€ç²¾é€‰ã€‘ã€ŠC++ å¹¶å‘ç¼–ç¨‹å®æˆ˜ ç¬¬äºŒç‰ˆã€‹ï¼šæ¡ä»¶å˜é‡å”¤é†’ä¸¢å¤±ä¸è™šå‡å”¤é†’_æ¡ä»¶å˜é‡çš„ä¼ªå”¤é†’-CSDNåšå®¢](https://blog.csdn.net/qq_39354847/article/details/126432944?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-126432944-blog-125381998.235%5Ev38%5Epc_relevant_sort_base1&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-126432944-blog-125381998.235%5Ev38%5Epc_relevant_sort_base1&utm_relevant_index=1)
while(!pred())
            wait(lock);
å’Œ cv.wait(lock, [](){ return pred();});ç­‰åŒ
(åšå®¢é“¾æ¥é‡Œé‚£äººå†™é”™äº†æ³¨æ„)
ç”¨ç¬¬äºŒç§ç­‰æ•ˆå†™æ³•ç®€æ´ï¼Œå†…éƒ¨æ¨¡æ¿è‡ªåŠ¨å¾ªç¯å®Œæˆæ£€æŸ¥é¿å…spurious awakeï¼›
å®é™…ä¸Šè¿™å°±æ˜¯ä¸€ä¸ªè™šå‡å”¤é†’ï¼Œå”¤é†’åå¹¶æ— å·¥ä½œå¯åšã€‚
_[other]_
_å…¶å®é™¤äº†waitï¼Œè¿˜æœ‰å¸¦è¶…æ—¶å‚æ•°çš„wait_foré«˜çº§ç­‰å¾…ï¼›_
_è‡³äºä¸ºäº†æ²¡æœ‰notify_allæˆ–è€…notify_oneä¹Ÿèƒ½å”¤é†’é˜»å¡çº¿ç¨‹å‘¢ï¼Ÿåº”è¯¥æ˜¯ç¨‹åºç»“æŸæ—¶å€™è‡ªåŠ¨æ¿€æ´»çš„notify_allæˆ–è€…ä¸€äº›spurious notifyï¼›_
[ã€ç²¾é€‰ã€‘C++å¹¶å‘ç¼–ç¨‹(7)ï¼šæ¡ä»¶å˜é‡ï¼ˆconditional variableï¼‰ã€wait( )ä¸notify_one( )ã€spurious wakeups(è™šå‡å”¤é†’)_åˆå·¥å¤§æœºå™¨äººå®éªŒå®¤çš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/qq_34935373/article/details/124813627)
###### acceptã€epollæƒŠç¾¤é—®é¢˜
[LinuxæƒŠç¾¤æ•ˆåº”è¯¦è§£ï¼ˆæœ€è¯¦ç»†çš„äº†å§ï¼‰-CSDNåšå®¢](https://blog.csdn.net/lyztyycode/article/details/78648798?locationNum=6&fps=1)
###### SO_REUSEADDRå’ŒSO_REUSEPORTå‚æ•°åŒºåˆ«
[ç½‘ç»œç¼–ç¨‹ä¸­çš„SO_REUSEADDRå’ŒSO_REUSEPORTå‚æ•°è¯¦è§£_Milu_Jingyuçš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/Milu_Jingyu/article/details/129161024)
å‰è€…æ˜¯4æ¬¡æŒ¥æ‰‹åçš„TIME_WAITé˜¶æ®µèƒ½å¤Ÿç«¯å£å¤ç”¨ï¼›
åè€…ç”¨é€”ï¼š
ç›®çš„ï¼š**æ¯ä¸€ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç›‘å¬socketï¼Œå¹¶ä¸”bindç›¸åŒçš„ip:portï¼Œç‹¬ç«‹çš„listen()å’Œaccept()ï¼›æé«˜æ¥æ”¶è¿æ¥çš„èƒ½åŠ›ã€‚ï¼ˆä¾‹å¦‚nginxå¤šè¿›ç¨‹åŒæ—¶ç›‘å¬åŒä¸€ä¸ªip:portï¼‰ï¼Œ**å¹¶ä¸”åœ¨å†…æ ¸å±‚é¢å®ç°è‡ªåŠ¨è´Ÿè½½å‡è¡¡
###### å¦‚æœç”¨æ°´å¹³è§¦å‘è¿˜ä¸æƒ³åå¤é€šçŸ¥æ€ä¹ˆåŠï¼Ÿå¦‚æœç”¨è¾¹æ²¿è§¦å‘ç¼“å†²åŒºå¤§å°ä¸å¤Ÿä¸èƒ½ä¸€æ¬¡è¯»å®Œæ€ä¹ˆåŠï¼Ÿ
LTä¸æƒ³åå¤é€šçŸ¥å°±
å‚è€ƒï¼š
[epollåœ¨LTå’ŒETæ¨¡å¼ä¸‹çš„è¯»å†™æ–¹å¼](https://www.yuque.com/xujunze/backend/qpan0b?view=doc_embed)

-  åœ¨epollçš„ETæ¨¡å¼ä¸‹, æ­£ç¡®çš„è¯»å†™æ–¹å¼ä¸º:

è¯»: åªè¦å¯è¯», å°±ä¸€ç›´è¯», ç›´åˆ°è¿”å›0, æˆ–è€… errno = EAGAIN
å†™: åªè¦å¯å†™, å°±ä¸€ç›´å†™, ç›´åˆ°æ•°æ®å‘é€å®Œ, æˆ–è€… errno = EAGAIN

- å¯¹äºnon-blockingçš„socket,  æ­£ç¡®çš„è¯»å†™æ“ä½œä¸º:

è¯»: å¿½ç•¥æ‰errno = EAGAINçš„é”™è¯¯, ä¸‹æ¬¡ç»§ç»­è¯» 
å†™: å¿½ç•¥æ‰errno = EAGAINçš„é”™è¯¯, ä¸‹æ¬¡ç»§ç»­å†™ 
å¯¹äºselectå’Œepollçš„LTæ¨¡å¼, è¿™ç§è¯»å†™æ–¹å¼æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚
> (æ³¨: EAGAINå°±æ˜¯EWOULDBLOCK)
> ä»å­—é¢ä¸Šçœ‹, æ„æ€æ˜¯:
> * EAGAIN: å†è¯•ä¸€æ¬¡
> * EWOULDBLOCK: å¦‚æœè¿™æ˜¯ä¸€ä¸ªé˜»å¡socket, æ“ä½œå°†è¢«block
> * perrorè¾“å‡º:  Resource temporarily unavailable

